"use strict";(self.webpackChunkkoordinator_sh=self.webpackChunkkoordinator_sh||[]).push([[1277],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>b});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),d=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=d(e.components);return r.createElement(l.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=d(n),u=a,b=p["".concat(l,".").concat(u)]||p[u]||m[u]||i;return n?r.createElement(b,s(s({ref:t},c),{},{components:n})):r.createElement(b,s({ref:t},c))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=u;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[p]="string"==typeof e?e:a,s[1]=o;for(var d=2;d<i;d++)s[d]=n[d];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2339:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var r=n(7462),a=(n(7294),n(3905));const i={},s="Network Bandwidth Limitation Using Terway QoS",o={unversionedId:"best-practices/network-qos-with-terwayqos",id:"best-practices/network-qos-with-terwayqos",title:"Network Bandwidth Limitation Using Terway QoS",description:"Introduction",source:"@site/docs/best-practices/network-qos-with-terwayqos.md",sourceDirName:"best-practices",slug:"/best-practices/network-qos-with-terwayqos",permalink:"/docs/next/best-practices/network-qos-with-terwayqos",draft:!1,editUrl:"https://github.com/koordinator-sh/koordinator.sh/edit/main/docs/best-practices/network-qos-with-terwayqos.md",tags:[],version:"current",lastUpdatedBy:"l1b0k",lastUpdatedAt:1712647832,formattedLastUpdatedAt:"Apr 9, 2024",frontMatter:{},sidebar:"docs",previous:{title:"Running Hadoop YARN with K8s by Koordinator",permalink:"/docs/next/best-practices/colocation-of-hadoop-yarn"},next:{title:"Component Guide",permalink:"/docs/next/developer-guide/component-guide"}},l={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Configuration Parameters",id:"configuration-parameters",level:2},{value:"Setting Whole-Machine Bandwidth Limitation",id:"setting-whole-machine-bandwidth-limitation",level:3},{value:"Pod Bandwidth Limitation",id:"pod-bandwidth-limitation",level:3},{value:"Kernel Version",id:"kernel-version",level:2},{value:"Limitation",id:"limitation",level:3},{value:"Deploying Koordinator",id:"deploying-koordinator",level:2},{value:"Deploying Terway QoS",id:"deploying-terway-qos",level:2},{value:"Usage Effects",id:"usage-effects",level:2}],c={toc:d},p="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"network-bandwidth-limitation-using-terway-qos"},"Network Bandwidth Limitation Using Terway QoS"),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"The birth of terway-qos is to address the issue of network bandwidth contention in mixed deployment scenarios. It supports bandwidth limitation by individual Pods and by business type.\nCompared to other solutions, terway-qos has the following advantages:"),(0,a.kt)("p",null,"Supports bandwidth limitation by business type, accommodating mixed deployment of various business types.\nSupports dynamic adjustment of Pod bandwidth limitations.\nProvides whole-machine bandwidth limitation, supporting multiple network cards.\nSupports bandwidth limitation for container networks and HostNetwork Pods."),(0,a.kt)("p",null,"Terway QoS includes three bandwidth priority levels, which correspond to Koordinator\u2019s default QoS mapping as follows."),(0,a.kt)("p",null,"You can set QoS priority for Pods using the familiar Koordinator configuration."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Koordinator QoS"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Kubernetes QoS"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Terway Net QoS"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"SYSTEM"),(0,a.kt)("td",{parentName:"tr",align:"left"},"--"),(0,a.kt)("td",{parentName:"tr",align:"left"},"L0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"LSE"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Guaranteed"),(0,a.kt)("td",{parentName:"tr",align:"left"},"L1")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"LSR"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Guaranteed"),(0,a.kt)("td",{parentName:"tr",align:"left"},"L1")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"LS"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Guaranteed/Burstable"),(0,a.kt)("td",{parentName:"tr",align:"left"},"L1")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"BE"),(0,a.kt)("td",{parentName:"tr",align:"left"},"BestEffort"),(0,a.kt)("td",{parentName:"tr",align:"left"},"L2")))),(0,a.kt)("h2",{id:"configuration-parameters"},"Configuration Parameters"),(0,a.kt)("h3",{id:"setting-whole-machine-bandwidth-limitation"},"Setting Whole-Machine Bandwidth Limitation"),(0,a.kt)("p",null,"In mixed deployment scenarios, we expect online businesses to have maximum bandwidth assurance to avoid contention. During idle times, offline businesses can also make full use of all bandwidth resources."),(0,a.kt)("p",null,"Thus, users can define three priority levels for business traffic: L0, L1, L2. Their priority decreases in that order.\nDefinition of contention scenario: When the total traffic of L0 + L1 + L2 exceeds the whole-machine bandwidth."),(0,a.kt)("p",null,"L0\u2019s maximum bandwidth dynamically adjusts based on the real-time traffic of L1 and L2. It can be as high as the whole-machine bandwidth and as low as whole-machine bandwidth - L1\u2019s minimum bandwidth - L2\u2019s minimum bandwidth.\nUnder any circumstances, the bandwidth of L1 and L2 does not exceed their respective upper limits.\nIn a contention scenario, the bandwidth of L1 and L2 will not fall below their respective lower limits.\nIn a contention scenario, bandwidth will be limited in the order of L2, L1, and L0. As Terway QoS has only three priority levels, the whole-machine bandwidth limitation can only be set for LS and BE, and the remaining L0 part is calculated based on the whole-machine\u2019s bandwidth cap. "),(0,a.kt)("p",null,"Here is an example configuration:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'resource-qos-config: |\n    {\n      "clusterStrategy": {\n        "policies": {"netQOSPolicy":"terway-qos"},\n        "lsClass": {\n          "networkQOS": {\n            "enable": true,\n            "ingressRequest": "50M",\n            "ingressLimit": "100M",\n            "egressRequest": "50M",\n            "egressLimit": "100M"\n          }\n        },\n        "beClass": {\n          "networkQOS": {\n            "enable": true,\n            "ingressRequest": "10M",\n            "ingressLimit": "200M",\n            "egressRequest": "10M",\n            "egressLimit": "200M"\n          }\n        }\n      }\n    }\nsystem-config: |-\n    {\n      "clusterStrategy": {\n        "totalNetworkBandwidth": "600M"\n      }\n    }\n\n')),(0,a.kt)("p",null,"Please note:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"clusterStrategy.policies.netQOSPolicy")," must set to ",(0,a.kt)("inlineCode",{parentName:"li"},"terway-qos"))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Unit ",(0,a.kt)("inlineCode",{parentName:"p"},"bps"))),(0,a.kt)("h3",{id:"pod-bandwidth-limitation"},"Pod Bandwidth Limitation"),(0,a.kt)("p",null,"To specify bandwidth limitations for a Pod:"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Key"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Value"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"koordinator.sh/networkQOS"),(0,a.kt)("td",{parentName:"tr",align:"left"},'\'{"IngressLimit": "10M", "EgressLimit": "20M"}\'')))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Unit ",(0,a.kt)("inlineCode",{parentName:"p"},"bps"))),(0,a.kt)("h2",{id:"kernel-version"},"Kernel Version"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Supports kernel version 4.19 and above."),(0,a.kt)("li",{parentName:"ul"},"Tested on 5.10 (Alinux3), 4.19 (Alinux2). ")),(0,a.kt)("p",null,"On kernel 5.1 and above, EDT is used for Egress direction rate limiting. Other kernel versions and Ingress direction limitations use Token Bucket for rate limiting."),(0,a.kt)("h3",{id:"limitation"},"Limitation"),(0,a.kt)("p",null,"Under Kernel 5.10, ",(0,a.kt)("inlineCode",{parentName:"p"},"HostNetwork")," pod's priority is not supported. As we use ",(0,a.kt)("inlineCode",{parentName:"p"},"bpf_skb_cgroup_classid")," to get priority by cgroup , and the helper only work above 5.10."),(0,a.kt)("h2",{id:"deploying-koordinator"},"Deploying Koordinator"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Ensure that koordinator is installed and that the koordinator version is 1.5 or higher."),(0,a.kt)("li",{parentName:"ol"},"The koordlet needs to be configured with RuntimeHook.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'helm install koordinator koordinator-sh/koordinator --version 1.5.0 --set koordlet.features="TerwayQoS=true\\,BECPUEvict=true\\,BEMemoryEvict=true\\,CgroupReconcile=true\\,Accelerators=true"\n')),(0,a.kt)("h2",{id:"deploying-terway-qos"},"Deploying Terway QoS"),(0,a.kt)("p",null,"Execute the following command to install. After starting, it will mount the tc eBPF program on the ingress and egress directions of the host network card."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"helm install -nkube-system terway-qos --set qos.qosConfigSource=file oci://registry-1.docker.io/l1b0k/terway-qos --version 0.3.2\n")),(0,a.kt)("h2",{id:"usage-effects"},"Usage Effects"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Key"),(0,a.kt)("th",{parentName:"tr",align:"left"},"request"),(0,a.kt)("th",{parentName:"tr",align:"left"},"limit"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"total"),(0,a.kt)("td",{parentName:"tr",align:"left"},"600"),(0,a.kt)("td",{parentName:"tr",align:"left"},"600")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"ls (l1)"),(0,a.kt)("td",{parentName:"tr",align:"left"},"200"),(0,a.kt)("td",{parentName:"tr",align:"left"},"300")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"be (l2)"),(0,a.kt)("td",{parentName:"tr",align:"left"},"100"),(0,a.kt)("td",{parentName:"tr",align:"left"},"200")))),(0,a.kt)("p",null,"Under no contention, both l1 and l2 can utilize their maximum bandwidth."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"# iperf3 -R -c server-ls\nConnecting to host server-be, port 5201\nReverse mode, remote host server-be is sending\n[  4] local 172.16.1.217 port 53242 connected to 172.16.0.197 port 5201\n[ ID] Interval           Transfer     Bandwidth\n[  4]   0.00-1.00   sec  23.7 MBytes   199 Mbits/sec\n[  4]   1.00-2.00   sec  23.9 MBytes   200 Mbits/sec\n[  4]   2.00-3.00   sec  23.8 MBytes   199 Mbits/sec\n[  4]   3.00-4.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   4.00-5.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   5.00-6.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   6.00-7.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   7.00-8.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   8.00-9.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   9.00-10.00  sec  23.8 MBytes   200 Mbits/sec\n- - - - - - - - - - - - - - - - - - - - - - - - -\n[ ID] Interval           Transfer     Bandwidth       Retr\n[  4]   0.00-10.00  sec   246 MBytes   207 Mbits/sec    0             sender\n[  4]   0.00-10.00  sec   238 MBytes   200 Mbits/sec                  receiver\n\n# iperf3 -R -c server-ls\nConnecting to host server-ls, port 5201\nReverse mode, remote host server-ls is sending\n[  4] local 172.16.1.217 port 43426 connected to 172.16.0.187 port 5201\n[ ID] Interval           Transfer     Bandwidth\n[  4]   0.00-1.00   sec  35.2 MBytes   295 Mbits/sec\n[  4]   1.00-2.00   sec  35.2 MBytes   296 Mbits/sec\n[  4]   2.00-3.00   sec  35.3 MBytes   296 Mbits/sec\n[  4]   3.00-4.00   sec  35.2 MBytes   296 Mbits/sec\n[  4]   4.00-5.00   sec  35.2 MBytes   296 Mbits/sec\n[  4]   5.00-6.00   sec  35.2 MBytes   296 Mbits/sec\n[  4]   6.00-7.00   sec  35.3 MBytes   296 Mbits/sec\n[  4]   7.00-8.00   sec  35.3 MBytes   296 Mbits/sec\n[  4]   8.00-9.00   sec  35.2 MBytes   296 Mbits/sec\n[  4]   9.00-10.00  sec  34.9 MBytes   293 Mbits/sec\n- - - - - - - - - - - - - - - - - - - - - - - - -\n[ ID] Interval           Transfer     Bandwidth       Retr\n[  4]   0.00-10.00  sec   360 MBytes   302 Mbits/sec    0             sender\n[  4]   0.00-10.00  sec   352 MBytes   295 Mbits/sec                  receiver\n")),(0,a.kt)("p",null,"Under contention"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"# iperf3 -R -c server-be -t 30\nConnecting to host server-be, port 5201\nReverse mode, remote host server-be is sending\n[  4] local 172.16.1.217 port 42142 connected to 172.16.0.187 port 5201\n[ ID] Interval           Transfer     Bandwidth\n[  4]   0.00-1.00   sec  23.8 MBytes   199 Mbits/sec\n[  4]   1.00-2.00   sec  23.8 MBytes   200 Mbits/sec\n[  4]   2.00-3.00   sec  21.9 MBytes   183 Mbits/sec\n[  4]   3.00-4.00   sec  14.4 MBytes   121 Mbits/sec\n[  4]   4.00-5.00   sec  11.0 MBytes  92.3 Mbits/sec\n[  4]   5.00-6.00   sec  11.0 MBytes  92.2 Mbits/sec\n[  4]   6.00-7.00   sec  8.53 MBytes  71.6 Mbits/sec\n[  4]   7.00-8.00   sec  10.9 MBytes  91.3 Mbits/sec\n[  4]   8.00-9.00   sec  10.8 MBytes  90.8 Mbits/sec\n[  4]   9.00-10.00  sec  11.0 MBytes  92.3 Mbits/sec\n[  4]  10.00-11.00  sec  11.0 MBytes  92.7 Mbits/sec\n[  4]  11.00-12.00  sec  11.0 MBytes  92.1 Mbits/sec\n\n# iperf3  -R -c server-ls -t 30\nConnecting to host server-ls, port 5201\nReverse mode, remote host server-ls is sending\n[  4] local 172.16.1.217 port 56826 connected to 172.16.0.197 port 5201\n[ ID] Interval           Transfer     Bandwidth\n[  4]   0.00-1.00   sec  35.2 MBytes   295 Mbits/sec\n[  4]   1.00-2.00   sec  35.3 MBytes   296 Mbits/sec\n[  4]   2.00-3.00   sec  35.2 MBytes   296 Mbits/sec\n[  4]   3.00-4.00   sec  26.4 MBytes   221 Mbits/sec\n[  4]   4.00-5.00   sec  16.9 MBytes   142 Mbits/sec\n[  4]   5.00-6.00   sec  20.6 MBytes   173 Mbits/sec\n[  4]   6.00-7.00   sec  21.6 MBytes   181 Mbits/sec\n[  4]   7.00-8.00   sec  21.1 MBytes   177 Mbits/sec\n[  4]   8.00-9.00   sec  21.6 MBytes   182 Mbits/sec\n[  4]   9.00-10.00  sec  21.2 MBytes   178 Mbits/sec\n[  4]  10.00-11.00  sec  21.8 MBytes   183 Mbits/sec\n")))}m.isMDXComponent=!0}}]);