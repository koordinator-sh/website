"use strict";(self.webpackChunkkoordinator_sh=self.webpackChunkkoordinator_sh||[]).push([[5051],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return c}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=d(n),c=o,h=m["".concat(l,".").concat(c)]||m[c]||u[c]||i;return n?a.createElement(h,r(r({ref:t},p),{},{components:n})):a.createElement(h,r({ref:t},p))}));function c(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var d=2;d<i;d++)r[d]=n[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},14:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return c},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return u}});var a=n(7462),o=n(3366),i=(n(7294),n(3905)),r=["components"],s={},l="PodMigrationJob",d={unversionedId:"user-manuals/pod-migration-job",id:"version-v0.7/user-manuals/pod-migration-job",title:"PodMigrationJob",description:"Koordinator defines a CRD-based Pod migration API called PodMigrationJob, through which the descheduler or other automatic fault recovery components can evict or delete Pods more safely.",source:"@site/versioned_docs/version-v0.7/user-manuals/pod-migration-job.md",sourceDirName:"user-manuals",slug:"/user-manuals/pod-migration-job",permalink:"/zh-Hans/docs/user-manuals/pod-migration-job",editUrl:"https://github.com/koordinator-sh/koordinator.sh/edit/main/docs/user-manuals/pod-migration-job.md",tags:[],version:"v0.7",lastUpdatedBy:"Joseph",lastUpdatedAt:1664180357,formattedLastUpdatedAt:"2022/9/26",frontMatter:{},sidebar:"docs",previous:{title:"Resource Reservation",permalink:"/zh-Hans/docs/user-manuals/resource-reservation"},next:{title:"Device Scheduling",permalink:"/zh-Hans/docs/user-manuals/fine-grained-device-scheduling"}},p={},u=[{value:"Introduction",id:"introduction",level:2},{value:"Setup",id:"setup",level:2},{value:"Prerequisite",id:"prerequisite",level:3},{value:"Installation",id:"installation",level:3},{value:"Configurations",id:"configurations",level:3},{value:"Use PodMigrationJob",id:"use-podmigrationjob",level:2},{value:"Quick Start",id:"quick-start",level:3},{value:"Advanced Configurations",id:"advanced-configurations",level:3},{value:"Example: Manually confirm whether the migration is allowed",id:"example-manually-confirm-whether-the-migration-is-allowed",level:3},{value:"Example: Just want to evict Pods, no need to reserve resources",id:"example-just-want-to-evict-pods-no-need-to-reserve-resources",level:3},{value:"Example: Use reserved resources when migrating",id:"example-use-reserved-resources-when-migrating",level:3},{value:"Example: Evicting Pods Gracefully",id:"example-evicting-pods-gracefully",level:3},{value:"Known Issues",id:"known-issues",level:3}],m={toc:u};function c(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"podmigrationjob"},"PodMigrationJob"),(0,i.kt)("p",null,"Koordinator defines a CRD-based Pod migration API called ",(0,i.kt)("inlineCode",{parentName:"p"},"PodMigrationJob"),", through which the descheduler or other automatic fault recovery components can evict or delete Pods more safely."),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Migrating Pods is an important capability that many components (such as deschedulers) rely on, and can be used to optimize scheduling or help resolve workload runtime quality issues. We believe that pod migration is a complex process, involving steps such as auditing, resource allocation, and application startup, and is mixed with application upgrading, scaling scenarios, and resource operation and maintenance operations by cluster administrators. Therefore, how to manage the stability risk of this process to ensure that the application does not fail due to the migration of Pods is a very critical issue that must be resolved."),(0,i.kt)("p",null,"Based on the final state-oriented migration capability of the PodMigrationJob CRD, we can track the status of each process during the migration process, perceive scenarios such as application upgrades and scaling to ensure the stability of the workload."),(0,i.kt)("h2",{id:"setup"},"Setup"),(0,i.kt)("h3",{id:"prerequisite"},"Prerequisite"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Kubernetes >= 1.18"),(0,i.kt)("li",{parentName:"ul"},"Koordinator >= 0.6")),(0,i.kt)("h3",{id:"installation"},"Installation"),(0,i.kt)("p",null,"Please make sure Koordinator components are correctly installed in your cluster. If not, please refer to ",(0,i.kt)("a",{parentName:"p",href:"/docs/installation"},"Installation"),"."),(0,i.kt)("h3",{id:"configurations"},"Configurations"),(0,i.kt)("p",null,"PodMigrationJob is ",(0,i.kt)("em",{parentName:"p"},"Enabled")," by default. You can use it without any modification on the koord-descheduler config."),(0,i.kt)("h2",{id:"use-podmigrationjob"},"Use PodMigrationJob"),(0,i.kt)("h3",{id:"quick-start"},"Quick Start"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a Deployment ",(0,i.kt)("inlineCode",{parentName:"li"},"pod-demo")," with the YAML file below.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: pod-demo\n  namespace: default\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      app: pod-demo\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 25%\n    type: RollingUpdate\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: pod-demo\n      name: stress\n    spec:\n      containers:\n      - args:\n        - -c\n        - "1"\n        command:\n        - stress\n        image: polinux/stress\n        imagePullPolicy: Always\n        name: stress\n        resources:\n          limits:\n            cpu: "2"\n            memory: 4Gi\n          requests:\n            cpu: 200m\n            memory: 400Mi\n      restartPolicy: Always\n      schedulerName: koord-scheduler\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl create -f pod-demo.yaml\ndeployment.apps/pod-demo created\n")),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Check the scheduled result of the pod ",(0,i.kt)("inlineCode",{parentName:"li"},"pod-demo-0"),".")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get pod -o wide\nNAME                        READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES\npod-demo-5f9b977566-c7lvk   1/1     Running   0          41s   10.17.0.9     node-0   <none>           <none>\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pod-demo-5f9b977566-c7lvk")," is scheduled on the node ",(0,i.kt)("inlineCode",{parentName:"p"},"node-0"),"."),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Create a ",(0,i.kt)("inlineCode",{parentName:"li"},"PodMigrationJob")," with the YAML file below to migrate ",(0,i.kt)("inlineCode",{parentName:"li"},"pod-demo-0"),".")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: scheduling.koordinator.sh/v1alpha1\nkind: PodMigrationJob\nmetadata:\n  name: migrationjob-demo\nspec:\n  paused: false\n  ttl: 5m\n  mode: ReservationFirst\n  podRef:\n    namespace: default\n    name: pod-demo-5f9b977566-c7lvk\nstatus:\n  phase: Pending\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl create -f migrationjob-demo.yaml\npodmigrationjob.scheduling.koordinator.sh/migrationjob-demo created\n")),(0,i.kt)("ol",{start:5},(0,i.kt)("li",{parentName:"ol"},"Query migration status")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get podmigrationjob migrationjob-demo\nNAME                PHASE     STATUS     AGE   NODE     RESERVATION                            PODNAMESPACE   POD                         NEWPOD                      TTL\nmigrationjob-demo   Succeed   Complete   37s   node-1   d56659ab-ba16-47a2-821d-22d6ba49258e   default        pod-demo-5f9b977566-c7lvk   pod-demo-5f9b977566-nxjdf   5m0s\n")),(0,i.kt)("p",null,"From the above results, it can be observed that:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"PHASE")," is ",(0,i.kt)("inlineCode",{parentName:"li"},"Succeed"),", ",(0,i.kt)("strong",{parentName:"li"},"STATUS")," is ",(0,i.kt)("inlineCode",{parentName:"li"},"Complete"),", indicating that the migration is successful. "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"NODE")," ",(0,i.kt)("inlineCode",{parentName:"li"},"node-1")," indicates the node where the new Pod is scheduled after the migration. "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"RESERVATION")," ",(0,i.kt)("inlineCode",{parentName:"li"},"d56659ab-ba16-47a2-821d-22d6ba49258e")," is the Reservation created during migration. The PodMigrationJob Controller will try to create the reserved resource for the Reservation before starting to evict the Pod. After the reservation is successful, the eviction will be initiated, which can ensure that the new Pod must be expelled. There are resources available. "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"PODNAMESPACE")," ",(0,i.kt)("inlineCode",{parentName:"li"},"default")," represents the namespace where the migrated Pod is located, "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"POD")," ",(0,i.kt)("inlineCode",{parentName:"li"},"pod-demo-5f9b977566-c7lvk")," represents the Pod to be migrated, "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"NEWPOD")," ",(0,i.kt)("inlineCode",{parentName:"li"},"pod-demo-5f9b977566-nxjdf")," is the newly created Pod after migration."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"TTL")," indicates the TTL period of the current Job.")),(0,i.kt)("ol",{start:6},(0,i.kt)("li",{parentName:"ol"},"Query migration events")),(0,i.kt)("p",null,"PodMigrationJob Controller will create Events for important steps in the migration process to help users diagnose migration problems"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'$ kubectl describe podmigrationjob migrationjob-demo\n...\nEvents:\n  Type    Reason                Age    From               Message\n  ----    ------                ----   ----               -------\n  Normal  ReservationCreated    8m33s  koord-descheduler  Successfully create Reservation "d56659ab-ba16-47a2-821d-22d6ba49258e"\n  Normal  ReservationScheduled  8m33s  koord-descheduler  Assigned Reservation "d56659ab-ba16-47a2-821d-22d6ba49258e" to node "node-1"\n  Normal  Evicting              8m33s  koord-descheduler  Try to evict Pod "default/pod-demo-5f9b977566-c7lvk"\n  Normal  EvictComplete         8m     koord-descheduler  Pod "default/pod-demo-5f9b977566-c7lvk" has been evicted\n  Normal  Complete              8m     koord-descheduler  Bind Pod "default/pod-demo-5f9b977566-nxjdf" in Reservation "d56659ab-ba16-47a2-821d-22d6ba49258e"\n')),(0,i.kt)("h3",{id:"advanced-configurations"},"Advanced Configurations"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"The latest API can be found in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/koordinator-sh/koordinator/blob/main/apis/scheduling/v1alpha1/pod_migration_job_types.go"},(0,i.kt)("inlineCode",{parentName:"a"},"pod_migration_job_types.go")),".")),(0,i.kt)("h3",{id:"example-manually-confirm-whether-the-migration-is-allowed"},"Example: Manually confirm whether the migration is allowed"),(0,i.kt)("p",null,"Eviction or migration operations that bring risks to the stability, so it is hoped to manually check and confirm that there is no error before initiating the migration operation, and then initiate the migration."),(0,i.kt)("p",null,"Therefore, when creating a PodMigrationJob, set ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.paused")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),", and set ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.paused")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"false")," after manually confirming that execution is allowed.\nIf you refuse to execute, you can update ",(0,i.kt)("inlineCode",{parentName:"p"},"status.phase=Failed")," to terminate the execution of the PodMigrationJob immediately or wait for the PodMigrationJob to expire automatically."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: scheduling.koordinator.sh/v1alpha1\nkind: PodMigrationJob\nmetadata:\n  name: migrationjob-demo\nspec:\n  # paused indicates whether the PodMigrationJob should to work or not.\n  paused: true\n  # ttl controls the PodMigrationJob timeout duration.\n  ttl: 5m\n  mode: ReservationFirst\n  podRef:\n    namespace: default\n    name: pod-demo-5f9b977566-c7lvk\nstatus:\n  phase: Pending\n")),(0,i.kt)("h3",{id:"example-just-want-to-evict-pods-no-need-to-reserve-resources"},"Example: Just want to evict Pods, no need to reserve resources"),(0,i.kt)("p",null,"PodMigrationJob provides two migration modes:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EvictDirectly")," is directly evict Pod, no need to reserve resources, "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ReservationFirst")," reserves resources first to ensure that resources can be allocated before initiating eviction.")),(0,i.kt)("p",null,"If just want to evict Pods, just set ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.mode")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"EvictDirectly")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: scheduling.koordinator.sh/v1alpha1\nkind: PodMigrationJob\nmetadata:\n  name: migrationjob-demo\nspec:\n  paused: false\n  ttl: 5m\n  mode: EvictDirectly\n  podRef:\n    namespace: default\n    name: pod-demo-5f9b977566-c7lvk\nstatus:\n  phase: Pending\n")),(0,i.kt)("h3",{id:"example-use-reserved-resources-when-migrating"},"Example: Use reserved resources when migrating"),(0,i.kt)("p",null,"In some scenarios, resources are reserved first, and then a PodMigrationJob is created after success.\nThe arbitration mechanism provided by the PodMigrationJob Controller (BTW: will be implemented in v0.7) is reused to ensure workload stability."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: scheduling.koordinator.sh/v1alpha1\nkind: PodMigrationJob\nmetadata:\n  name: migrationjob-demo\nspec:\n  paused: false\n  ttl: 5m\n  mode: ReservationFirst\n  podRef:\n    namespace: default\n    name: pod-demo-5f9b977566-c7lvk\n  reservationOptions:\n    # the reservation-0 created before creating PodMigrationJob\n    reservationRef:\n      name: reservation-0\nstatus:\n  phase: Pending\n")),(0,i.kt)("h3",{id:"example-evicting-pods-gracefully"},"Example: Evicting Pods Gracefully"),(0,i.kt)("p",null,"PodMigrationJob supports graceful eviction of pods."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: scheduling.koordinator.sh/v1alpha1\nkind: PodMigrationJob\nmetadata:\n  name: migrationjob-demo\nspec:\n  paused: true\n  ttl: 5m\n  mode: ReservationFirst\n  podRef:\n    namespace: default\n    name: pod-demo-5f9b977566-c7lvk\n  deleteOptions:\n    # The duration in seconds before the object should be deleted. Value must be non-negative integer.\n    # The value zero indicates delete immediately. If this value is nil, the default grace period for the\n    # specified type will be used.\n    # Defaults to a per object value if not specified. zero means delete immediately.\n    gracePeriodSeconds: 60\nstatus:\n  phase: Pending\n")),(0,i.kt)("h3",{id:"known-issues"},"Known Issues"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/koordinator-sh/koordinator/blob/main/docs/proposals/scheduling/20220701-pod-migration-job.md#filter-podmigrationjob"},"Arbitration mechanism")," is not currently supported. The v0.6 version only implements the migration capability based on resource reservation"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/koordinator-sh/koordinator/blob/main/docs/proposals/scheduling/20220701-pod-migration-job.md#basic-migration-api"},"Basic Migration API")," is not currenty supported")))}c.isMDXComponent=!0}}]);