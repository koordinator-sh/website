<!doctype html>
<html class="docs-version-current" lang="zh-Hans" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/zh-Hans/blog/rss.xml" title="Koordinator RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-Hans/blog/atom.xml" title="Koordinator Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Koordinator" href="/zh-Hans/opensearch.xml"><title data-rh="true">GangScheduling | Koordinator</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://koordinator.sh/zh-Hans/docs/next/designs/gang-scheduling"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="GangScheduling | Koordinator"><meta data-rh="true" name="description" content="Summary"><meta data-rh="true" property="og:description" content="Summary"><link data-rh="true" rel="icon" href="/zh-Hans/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://koordinator.sh/zh-Hans/docs/next/designs/gang-scheduling"><link data-rh="true" rel="alternate" href="https://koordinator.sh/docs/next/designs/gang-scheduling" hreflang="en"><link data-rh="true" rel="alternate" href="https://koordinator.sh/zh-Hans/docs/next/designs/gang-scheduling" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://koordinator.sh/docs/next/designs/gang-scheduling" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://FKASWWQYOP-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh-Hans/assets/css/styles.48d3146e.css">
<link rel="preload" href="/zh-Hans/assets/js/runtime~main.19761b98.js" as="script">
<link rel="preload" href="/zh-Hans/assets/js/main.05ff2898.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Ë∑≥Âà∞‰∏ªË¶ÅÂÜÖÂÆπ</a></div><div class="announcementBar_IbjG" role="banner"><div class="announcementBarPlaceholder_NC_W"></div><div class="announcementBarContent_KsVm">‚≠êÔ∏è If you like Koordinator, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/koordinator-sh/koordinator">GitHub</a>! ‚≠êÔ∏è</div><button type="button" class="clean-btn close announcementBarClose_FG1z" aria-label="ÂÖ≥Èó≠"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-Hans/"><div class="navbar__logo"><img src="/zh-Hans/img/logo.svg" alt="Koordinator" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/zh-Hans/img/logo.svg" alt="Koordinator" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Koordinator</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-Hans/docs">ÊñáÊ°£</a><a class="navbar__item navbar__link" href="/zh-Hans/blog">ÂçöÂÆ¢</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/zh-Hans/docs/next/">v1.1 üöß</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/zh-Hans/docs/next/designs/gang-scheduling">v1.1 üöß</a></li><li><a class="dropdown__link" href="/zh-Hans/docs/designs/gang-scheduling">v1.0</a></li><li><a class="dropdown__link" href="/zh-Hans/docs/v0.7/designs/gang-scheduling">v0.7</a></li><li><a class="dropdown__link" href="/zh-Hans/docs/v0.6/">v0.6</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>ÁÆÄ‰Ωì‰∏≠Êñá</span></span></a><ul class="dropdown__menu"><li><a href="/docs/next/designs/gang-scheduling" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh-Hans/docs/next/designs/gang-scheduling" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><a href="https://github.com/koordinator-sh/koordinator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="ÂàáÊç¢ÊµÖËâ≤/ÊöóÈªëÊ®°ÂºèÔºàÂΩìÂâç‰∏∫ÊµÖËâ≤Ê®°ÂºèÔºâ"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="ÊêúÁ¥¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">ÊêúÁ¥¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="ÂõûÂà∞È°∂ÈÉ®" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO menuWithAnnouncementBar_x19h"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-Hans/docs/next/">Âø´ÈÄüÂºÄÂßã</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/">ÁÆÄ‰ªã</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/installation">ÂÆâË£Ö</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-Hans/docs/next/architecture/overview">Êû∂ÊûÑ</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/architecture/overview">Ê¶ÇËø∞</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/architecture/resource-model">ËµÑÊ∫êÊ®°Âûã</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/architecture/priority">‰ºòÂÖàÁ∫ß</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/architecture/qos">QoS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-Hans/docs/next/user-manuals/colocation-profile">Áî®Êà∑ÊâãÂÜå</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/zh-Hans/docs/next/designs/koordlet-overview">ËÆæËÆ°</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/koordlet-overview">Koordlet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/runtime-proxy">RuntimeProxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/enhanced-scheduler-extension">Enhanced Scheduler Extension</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/load-aware-scheduling">Ë¥üËΩΩÊÑüÁü•Ë∞ÉÂ∫¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/fine-grained-cpu-orchestration">Fine-grained CPU orchestration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/resource-reservation">Resource Reservation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/pod-migration-job">PodMigrationJob</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/descheduler-framework">Descheduler Framework</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/fine-grained-device-scheduling">Fine-grained device scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh-Hans/docs/next/designs/gang-scheduling">GangScheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-Hans/docs/next/designs/multi-hierarchy-elastic-quota-management">Multi Hierarchy Elastic Quota Management</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-Hans/docs/next/best-practices/colocation-of-spark-jobs">ÊúÄ‰Ω≥ÂÆûË∑µ</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>Ê≠§‰∏∫ <!-- -->Koordinator<!-- --> <b>v1.1 üöß</b> ÁâàÂ∞öÊú™ÂèëË°åÁöÑÊñáÊ°£„ÄÇ</div><div class="margin-top--md">ÊúÄÊñ∞ÁöÑÊñáÊ°£ËØ∑ÂèÇÈòÖ <b><a href="/zh-Hans/docs/designs/gang-scheduling">ÊúÄÊñ∞ÁâàÊú¨</a></b> (<!-- -->v1.0<!-- -->)„ÄÇ</div></div><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/zh-Hans/">üè†</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">ËÆæËÆ°</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/zh-Hans/docs/next/designs/gang-scheduling">GangScheduling</a></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">ÁâàÊú¨Ôºöv1.1 üöß</span><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">Êú¨È°µÊÄªËßà</button></div><div class="theme-doc-markdown markdown"><h1>GangScheduling</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h2><p>This proposal provides Gang mechanism for the scheduler to control pods binding opportunity. User can declare a resource-collection-minimum number,
only when assigned-resources reach the given limitation can trigger the binding. We provide <code>Strict</code> and <code>NonStrict</code> to
control the resource-accumulation-process by a configuration. We also provide a two-level Gang description for better matching
the real scenario, which is different from community.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="motivation">Motivation<a class="hash-link" href="#motivation" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h2><p>In AI scenarios, lots of jobs need Gang scheduling. The community have lots of related implements such as <code>Coscheduling</code> or <code>vocalno</code>.
We received lots of inspirations in the design process from them.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="compared-with-competitors">Compared with competitors<a class="hash-link" href="#compared-with-competitors" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="coscheduling">Coscheduling<a class="hash-link" href="#coscheduling" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><ol><li><p><code>Coscheduling</code> implement a new queue-sort interface and other methods to let one Gang&#x27;s pods get out of the queue in order as much as possible.
If a pod failed to be scheduled, the requests that have been successfully scheduled in this round of Gang scheduling cycle will be rolled back,
and the remaining pods waiting for scheduling will be rejected in PreFilter check until this scheduling cycle passed.
For example, there is a Gang requires 10 tasks to be scheduled, if first 5 tasks allocated, the 6th task failed to be scheduled,
<code>Coscheduling</code> will roll-back first 5 tasks and ignore the remaining 4 tasks in this Gang scheduling cycle. <code>Coscheduling</code> simply use a
global time interval to control the Gang scheduling cycle. The first defect is that the uniform time interval will cause
some problems. If the time configuration is too long, it will lead to useless waiting; If the time configuration is too short,
it will lead to useless scheduling. Secondly, it is very difficult for a large job to meet all resource requests at one time.
This mechanism will lead to a very low probability of full resources, and eventually make the job starve to death. We call this process as <code>Strict</code>.</p></li><li><p>Some jobs have complex Gang requirements. For example, a job has several roles. Each role will have several pods
and its own Gang conditions. Jobs also need different roles to form different GangGroups. All pods in a GangGroup can
trigger the bind process only after all roles in a GangGroup meet their Gang conditions. The <code>Coscheduling</code> can&#x27;t meet
this requirement.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="goals">Goals<a class="hash-link" href="#goals" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h3><ol><li><p>Define API to announce Gang scheduling configuration.</p></li><li><p>Provides a scheduler plugin to achieve Gang scheduling ability.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="non-goals-and-future-work">Non Goals and Future Work<a class="hash-link" href="#non-goals-and-future-work" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h3><ol><li>Provide ability to solve Gang resource deadlock problems with <code>NonStrict</code>.</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="proposal">Proposal<a class="hash-link" href="#proposal" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="key-concept">Key concept<a class="hash-link" href="#key-concept" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="strict-and-nonstrict">Strict and NonStrict<a class="hash-link" href="#strict-and-nonstrict" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><p>As mentioned above, in <code>Strict</code>, if a pod failed to be scheduled, the pods that have been successfully scheduled in
this scheduling cycle will be rolled back, and the remaining pods waiting for scheduling will be rejected in
PreFilter check util this scheduling cycle passed. We call this mode is <code>Strict</code>.</p><p>In <code>NonStrict</code>, if a pod failed to be scheduled, it has no impact on any other pod. We will continue to accumulate
the allocated pod until the condition of Gang is met. This process is friendly to Gangs with large number of pods, but it
will increase the risk of resource deadlock between Gangs. For example, the quota of the quota group is 10(quota will be proposed later),
and the user submits three Gangs with 5 pods. Due to various plugin constraints, Gang1\2\3 may allocate resources of 3\3\4 respectively.
Since the quota group&#x27;s quota is full, there will be no new resource scheduling. We call this is resource deadlock of resource Gang.
In future proposal, we will try to fix this problem.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="ganggroup">GangGroup<a class="hash-link" href="#ganggroup" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><p>As mentioned above, Some jobs have complex Gang requirements. For example, a job has several roles. Each role will have several pods
and its own Gang conditions. Jobs also need different roles to form different GangGroups. All pods in a GangGroup can
trigger the bind process only after all roles in a GangGroup meet their Gang conditions. So we introduce <code>GangGroup</code> concept,
which allow user to bundle different Gangs together.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="after-gang">After Gang<a class="hash-link" href="#after-gang" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><p>It should be noted that, if the resource accumulation conditions of Gang are met, then some pods failed in the process of binding,
or some bound pods are preempted\rescheduled, should the constraints of Gang still be effective in the process of resource reallocation?
Because the initial purpose of Gang is to require pods to be pulled up at the same time, if some pods have been pulled up,
then the subsequent Gang behavior is meaningless. Therefore, when once Gang has been satisfied, all subsequent resource allocations
are no longer constrained by Gang rules, and their performance is similar to ordinary pod.</p><p>As mentioned above, <code>WaitTime</code> is the max wait time since first pod comes to permit stage. If <code>WaitTime</code> is timeout,
scheduler will roll back all assumed pods, update each pod&#x27;s annotation with <code>gang.scheduling.koordinator.sh/timeout=true</code>, and
won&#x27;t schedule these pods anymore. User should pay attention to this status and delete pods timely.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="api">API<a class="hash-link" href="#api" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="definition">Definition<a class="hash-link" href="#definition" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><p>Our original intention is to improve and enhance the ability of the community&#x27;s original <code>PodGroup</code>, so we will be
compatible with the way the community declares the <code>PodGroup</code>. We also provide a lighting way to just use annotations to
use Gang feature.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="crd-way">CRD way<a class="hash-link" href="#crd-way" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><p>User can use <code>PodGroup</code> CRD in community to declare a gang:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodGroup </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TypeMeta </span><span class="token string" style="color:#e3116c">`json:&quot;,inline&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta </span><span class="token string" style="color:#e3116c">`json:&quot;metadata,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Spec PodGroupSpec </span><span class="token string" style="color:#e3116c">`json:&quot;spec,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status PodGroupStatus </span><span class="token string" style="color:#e3116c">`json:&quot;status,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodGroupSpec </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MinMember </span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;minMember,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MinResources </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResourceList </span><span class="token string" style="color:#e3116c">`json:&quot;minResources,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScheduleTimeoutSeconds </span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;scheduleTimeoutSeconds,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>Pod should use <code>pod-group.scheduling.sigs.k8s.io</code> in label to associate with <code>PodGroup</code>.</p><p>Also, we introduce some optional definitions as below:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/total</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/mode        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/groups</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><ul><li><p><code>gang.scheduling.koordinator.sh/name</code> indicates the gang&#x27;s name, it should be emphasized that the name should be in the form of RFC 1123 </p></li><li><p><code>gang.scheduling.koordinator.sh/total-number</code> helps to calculate Gang scheduling cycle in <code>strict mode</code>, you can
find more detail in <code>Data-Structure</code> chapter. Default equals to <code>gang.scheduling.koordinator.sh/min-available</code>.</p></li><li><p><code>gang.scheduling.koordinator.sh/mode</code> determines <code>Strict</code> or <code>NonStrict</code>. Default is <code>Strict</code>.</p></li><li><p><code>gang.scheduling.koordinator.sh/groups</code> describes GangGroups. Default is empty, which means don&#x27;t need to form a <code>GangGroup</code> with others,
and the gangs in one gangGroup can from different namespaces.</p></li></ul><p><code>gang.scheduling.koordinator.sh/total-number</code>, <code>gang.scheduling.koordinator.sh/mode</code>, <code>gang.scheduling.koordinator.sh/gang-groups</code> should be found in
<code>PodGroup</code>&#x27;s annotation if needed.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="example">Example<a class="hash-link" href="#example" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h5><p>When user apply a basic gang, the example is as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PodGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">creationTimestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2022-07-11T18:26:33Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minMember</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minResources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2048Mi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scheduleTimeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>Let&#x27;s assume a job has two roles: A and B, each role has several pods. podA belongs to roleA, podB belongs to roleB.
roleA and roleB belongs to one GangGroup, the example is as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PodGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">creationTimestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2022-07-11T18:26:33Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> namespaceA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/total-number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Strict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;namespaceA/gang-a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;namespaceB/gang-b&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minMember</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minResources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2048Mi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scheduleTimeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>It should be noted that, if use Gang feature by <code>CRD way</code>, user should let high level operator maintain Gang CRD life circle
like handling <code>update/create/delete</code> events. Also, from a Scheduler perspective, scheduler should handle receive-order-issue&#x27;s
between Gang CRD and pod. For example, if pods arrive to scheduler before Gang CRD, we have to build a fake Gang data structure
temporarily to collect all related pods, and need to suspend the scheduling of pods until parse the configuration from real Gang CRD.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="annotation-way">Annotation way<a class="hash-link" href="#annotation-way" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/name           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/min</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">available</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>The upper definitions are indispensable. We are compatible with <code>pod-group.scheduling.sigs.k8s.io</code>, <code>pod-group.scheduling.sigs.k8s.io/name</code>
and <code>pod-group.scheduling.sigs.k8s.io/min-available</code> in community. We also support new definitions to declare Gang&#x27;s name and minimum number.</p><p>Also, we introduce some optional definitions as below, most are mentioned above:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/waiting</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/total</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/mode        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gang.scheduling.koordinator.sh/groups</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><ul><li><p><code>gang.scheduling.koordinator.sh/waiting-time</code> represents max wait time since first pod comes to permit stage. Default is a global config.</p></li><li><p><code>gang.scheduling.koordinator.sh/total-number</code> helps to calculate Gang scheduling cycle in <code>strict mode</code>, you can
find more detail in <code>Data-Structure</code> chapter. Default equals to <code>gang.scheduling.koordinator.sh/min-available</code>.</p></li><li><p><code>gang.scheduling.koordinator.sh/mode</code> determines <code>Strict</code> or <code>NonStrict</code>. Default is <code>Strict</code>.</p></li><li><p><code>gang.scheduling.koordinator.sh/groups</code> describes GangGroups. Default is empty, which means don&#x27;t need to form a <code>GangGroup</code> with others.</p></li></ul><p>It should be noted that, the annotation mode&#x27;s parameter will overwrite CRD&#x27;s mode if both exist.
And gangGroup should be announced with &quot; gangNamespace&quot; + &quot;/&quot; + &quot;gangName &quot;</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="example-1">Example<a class="hash-link" href="#example-1" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h5><p>When user apply a basic gang, the example is as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/min-available</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>Let&#x27;s assume a job has two roles: A and B, each role has several pods. PodA belongs to roleA, podB belongs to roleB.
roleA and roleB belongs to one GangGroup, the example is as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/waiting-time</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3600s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/min-available</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/total-number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Strict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;namespaceA/gang-a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;namespaceB/gang-b&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/waiting-time</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3600s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/min-available</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/total-number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Strict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;namespaceA/gang-a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;namespaceB/gang-b&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>Assuming a job has two roles: A and B, each role has several pods. podA belongs to roleA, podB belongs to roleB.
roleA and roleB belongs to different GangGroup, the example as follows:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/waiting-time</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3600s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/min-available</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/total-number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Strict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gang</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/waiting-time</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3600s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/min-available</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/total-number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Strict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">gang.scheduling.koordinator.sh/groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="implementation-details">Implementation Details<a class="hash-link" href="#implementation-details" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="queuesortplugin">QueueSortPlugin<a class="hash-link" href="#queuesortplugin" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><p>We design an independent plugin to implement the <code>QueueSort</code> extension point separately, so that we can integrate
queue sort logic of all plugins, and register them at one time.</p><p>In this proposal, we implement the Less function to gather pods belong to same Gang. The specific queuing rule is:</p><ol><li><p>Firstly, compare the priorities of the two pods, the higher priority is at the front of the queue.</p></li><li><p>Secondly, compare creationTimestamp of two pods, if pod belongs to a Gang, then we compare creationTimestamp of the Gang,
the one created first will be at the front of the queue.</p></li><li><p>Finally, compare pod&#x27;s namespace, if pod belongs to a Gang, then we compare Gang name. </p></li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> QueueSortPlugin </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">QueueSort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">QueuedPodInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">QueuedPodInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="gangschedulingplugin">GangSchedulingPlugin<a class="hash-link" href="#gangschedulingplugin" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="data-structure">Data-Structure<a class="hash-link" href="#data-structure" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h5><h6 class="anchor anchorWithStickyNavbar_mojV" id="gang">Gang<a class="hash-link" href="#gang" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h6><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Gang </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name                         </span><span class="token builtin">string</span><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WaitTime                     time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration                       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mode                         </span><span class="token builtin">string</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">//Strict or NonStrict</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GangGroup                    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token plain">               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MinRequiredNumber            </span><span class="token builtin">int</span><span class="token plain">                    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TotalChildrenNum             </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Children                     </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodInfo  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BoundChildren                </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WaitingForBindChildren       </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResourceSatisfied            </span><span class="token builtin">bool</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScheduleCycle                </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScheduleCycleValid           </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ChildrenScheduleRoundMap     </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>We design the Gang to record Gang status in scheduler memory. We can get the children pods from &quot;Children&quot; field, and the
<code>BoundChildren, WaitingForBindChildren</code> store the pods binding status, which is used to check if the pods can pass permit stage.</p><p>Once Permit stage passed, we will set <code>ResourceSatisfied=true</code>, as mentioned above in <code>After Gang</code> chapter, this variable is
used for judging whether gang has been satisfied. when handle failover case, if any pod in Gang has been bound, we set <code>ResourceSatisfied=true</code>.</p><p>We especially explain <code>scheduleCycle</code> and <code>childrenScheduleRoundMap</code> field. These fields control Gang&#x27;s scheduling cycle. For example,
at the beginning, <code>scheduleCycle</code> is 1, and each pod&#x27;s cycle in <code>childrenScheduleRoundMap</code> is 0. When each pod comes to PreFilter,
we will check if the pod&#x27;s value in <code>childrenScheduleRoundMap</code> is smaller than Gang&#x27;s <code>scheduleCycle</code>, If result is positive,
we set the pod&#x27;s cycle in <code>childrenScheduleRoundMap</code> equal with <code>scheduleCycle</code> and pass the check. If result is negative, means
the pod has been scheduled in this cycle, so we should reject it. With <code>totalChildrenNum</code>&#x27;s help, when the last pod comes to make all
<code>childrenScheduleRoundMap</code>&#x27;s values equal to <code>scheduleCycle</code>, Gang&#x27;s <code>scheduleCycle</code> will be added by 1, which means a new schedule cycle.</p><p>We continue to explain <code>scheduleCycleValid</code> field, during the scheduling,  When a pod failed at Filter stage, we will set ScheduleCycleValid to
false in PostFilter stage, which means any pod in this Gang shouldn&#x27;t be scheduled until it is set to &quot;true&quot;,
and the remaining pods should be rejected in PreFilter stage. Only When <code>scheduleCycle</code> added by 1, we will reset the <code>scheduleCycleValid</code> to true.</p><p>It should be emphasized that <code>scheduleCycle\scheduleCycleValid\childrenScheduleRoundMap</code> only work in <code>Strict</code>. </p><h5 class="anchor anchorWithStickyNavbar_mojV" id="gangplugin">GangPlugin<a class="hash-link" href="#gangplugin" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h5><p>this is the framework of the Plugin,we cache the Gang info above in the gangCache.</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GangPlugin </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    frameworkHandler            framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gangClient                  gangClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    podLister                   listerv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshotSharedLister        framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SharedLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gangCache                   </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Gang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><p>during the whole kubernetes shceduling process,we only need to realize our logic into four extention points as below:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PreFilterPlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">GangScheduling</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PostFilterPlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">GangScheduling</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PermitPlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">GangScheduling</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReservePlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">Coscheduling</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GangScheduling </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ActiveGang</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CycleState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PreFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PostFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CycleState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> filteredNodeStatusMap NodeToStatusMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PostFilterResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Permit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Unreserve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">framework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CycleState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodeName </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø" class="copyButton_wuS7 clean-btn">Â§çÂà∂</button></div></div><h6 class="anchor anchorWithStickyNavbar_mojV" id="prefilter"><strong>PreFilter</strong><a class="hash-link" href="#prefilter" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h6><p>if <code>NonStrict</code>, we only do step1 and step2:</p><ul><li><p>Check whether childes in Gang has met the requirements of minimum number under each Gang, and reject the pod if negative.</p></li><li><p>Check whether the Gang has been timeout(check the pod&#x27;s annotation,later introduced at Permit section), and reject the pod if positive.</p></li><li><p>Check whether the Gang has met the <code>scheduleCycleValid</code> check, and reject the pod if negative.</p></li><li><p>Try update <code>scheduleCycle</code>, <code>scheduleCycleValid</code>, <code>childrenScheduleRoundMap</code> as mentioned above.</p></li></ul><h6 class="anchor anchorWithStickyNavbar_mojV" id="postfilter"><strong>PostFilter</strong><a class="hash-link" href="#postfilter" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h6><p>At this point means the pod didn&#x27;t pass the Filter Plugin, we should:</p><ul><li><p>If <code>Strict</code>, we will set <code>scheduleCycleValid</code> to false and release all assumed pods.</p></li><li><p>If <code>NonStrict</code>, we will do nothing.</p></li></ul><h6 class="anchor anchorWithStickyNavbar_mojV" id="permit"><strong>Permit</strong><a class="hash-link" href="#permit" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h6><p>Any pod passes Filter stage will come to this stage. Scheduler will calculate all Gangs in GangGroup whether the current
number of assumed-pods in each Gang meets the Gang&#x27;s minimum requirement.</p><ul><li>If Gang don&#x27;t meet the bind-condition, we will give the pod a &quot;Wait&quot; Status with a timeout duration, and the bind
goroutine will keep waiting until the wait is timeout or passed. Then we will run the <code>ActiveGang</code> method, it can put all
the pods belong to the Gang which in <code>schedulableQueue</code> or <code>backoffQueue</code> back to <code>activeQueue</code>, so that the pod of Gang
can be continuously scheduled as much as possible. </li></ul><p>It should be noted that, in community, scheduler limit maximum timeout value under 15 min, we may need to hook RunPermitPlugins
to enlarge the timeout when 15 minutes is not enough. Now we record as a known-issue.</p><ul><li>If Gang meet the bind-condition, we will give every waiting pod a &quot;Success&quot; status, which will let the bind goroutine of
each pod leave the waiting status and continue to run. Also, as mentioned above, we will set Gang&#x27;s <code>ResourceSatisfied</code> to true.</li></ul><h6 class="anchor anchorWithStickyNavbar_mojV" id="un-reserve"><strong>Un-reserve</strong><a class="hash-link" href="#un-reserve" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h6><p>Both permit stage is timeout and binding failed will lead the pod to un-reserve stage, we can distinguish from Gang&#x27;s &quot;ResourceSatisfied&quot; field,
if the field is true means binding failed, else means the Gang is timeout.</p><ul><li><p>When permit stage is timeout, we will give an annotation like <code>gang.scheduling.koordinator.sh/timeout=true</code> to all the pods
belong to the Gang and will release the resource of all the assumed pods. The Gang will not be scheduled anymore,
user should manually handle the timeout event.</p></li><li><p>When binding failed, as mentioned above, the collection of Gang&#x27;s resource is over, we will do nothing except roll back
the failed pod resource.</p></li></ul><h6 class="anchor anchorWithStickyNavbar_mojV" id="init"><strong>Init</strong><a class="hash-link" href="#init" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h6><p>We will register pod&#x27;s event handler to watch pod event for updating Gang.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="unsolved-problems">Unsolved Problems<a class="hash-link" href="#unsolved-problems" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h2><h2 class="anchor anchorWithStickyNavbar_mojV" id="alternatives">Alternatives<a class="hash-link" href="#alternatives" title="Ê†áÈ¢òÁöÑÁõ¥Êé•ÈìæÊé•">‚Äã</a></h2><p>User can choose use Gang by <code>Strict</code> and <code>NonStrict</code> case by case.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/koordinator-sh/koordinator.sh/edit/main/docs/designs/gang-scheduling.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ÁºñËæëÊ≠§È°µ</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">ÊúÄÂêé<!-- -->Áî± <b>leason</b> <!-- -->‰∫é <b><time datetime="2022-10-25T08:46:11.000Z">2022/10/25</time></b> <!-- -->Êõ¥Êñ∞</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ÊñáÊ°£ÂàÜÈ°µÂØºËà™"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh-Hans/docs/next/designs/fine-grained-device-scheduling"><div class="pagination-nav__sublabel">‰∏ä‰∏ÄÈ°µ</div><div class="pagination-nav__label">Fine-grained device scheduling</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh-Hans/docs/next/designs/multi-hierarchy-elastic-quota-management"><div class="pagination-nav__sublabel">‰∏ã‰∏ÄÈ°µ</div><div class="pagination-nav__label">Multi Hierarchy Elastic Quota Management</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a><ul><li><a href="#compared-with-competitors" class="table-of-contents__link toc-highlight">Compared with competitors</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals-and-future-work" class="table-of-contents__link toc-highlight">Non Goals and Future Work</a></li></ul></li><li><a href="#proposal" class="table-of-contents__link toc-highlight">Proposal</a><ul><li><a href="#key-concept" class="table-of-contents__link toc-highlight">Key concept</a></li><li><a href="#api" class="table-of-contents__link toc-highlight">API</a></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation Details</a></li></ul></li><li><a href="#unsolved-problems" class="table-of-contents__link toc-highlight">Unsolved Problems</a></li><li><a href="#alternatives" class="table-of-contents__link toc-highlight">Alternatives</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ÊñáÊ°£</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/docs/next/designs/docs/installation">Âø´ÈÄüÂºÄÂßã</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/docs/next/designs/docs/user-manuals/colocation-profile">Áî®Êà∑ÊâãÂÜå</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/docs/next/designs/docs/architecture/overview">Êû∂ÊûÑ</a></li></ul></div><div class="col footer__col"><div class="footer__title">Á§æÂå∫</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/koordinator-sh/shared_invite/zt-1756qoub4-Cn4~esfdlfAPsD7cwO2NzA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack ( #koordinator channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/docs/next/designs/">DingTalk (GroupID: 33383887)</a></li></ul></div><div class="col footer__col"><div class="footer__title">Êõ¥Â§ö</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/koordinator-sh/koordinator" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/docs/next/designs/blog">ÂçöÂÆ¢</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright ¬© 2022 The Koordinator Authors. All rights reserved.</strong></div></div></div></footer></div>
<script src="/zh-Hans/assets/js/runtime~main.19761b98.js"></script>
<script src="/zh-Hans/assets/js/main.05ff2898.js"></script>
</body>
</html>