<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v1.6 plugin-docs plugin-id-default docs-doc-id-designs/multi-hierarchy-elastic-quota-management">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Multi Hierarchy Elastic Quota Management | Koordinator</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://koordinator.sh/docs/designs/multi-hierarchy-elastic-quota-management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v1.6"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v1.6"><meta data-rh="true" name="docsearch:version" content="v1.6"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v1.6"><meta data-rh="true" property="og:title" content="Multi Hierarchy Elastic Quota Management | Koordinator"><meta data-rh="true" name="description" content="Summary"><meta data-rh="true" property="og:description" content="Summary"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://koordinator.sh/docs/designs/multi-hierarchy-elastic-quota-management"><link data-rh="true" rel="alternate" href="https://koordinator.sh/docs/designs/multi-hierarchy-elastic-quota-management" hreflang="en"><link data-rh="true" rel="alternate" href="https://koordinator.sh/zh-Hans/docs/designs/multi-hierarchy-elastic-quota-management" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://koordinator.sh/docs/designs/multi-hierarchy-elastic-quota-management" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://FKASWWQYOP-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Koordinator RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Koordinator Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Koordinator" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.d55f2266.css">
<link rel="preload" href="/assets/js/runtime~main.d9e3305a.js" as="script">
<link rel="preload" href="/assets/js/main.e0aacdd2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">‚≠êÔ∏è If you like Koordinator, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/koordinator-sh/koordinator">GitHub</a>! ‚≠êÔ∏è</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Koordinator" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Koordinator" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Koordinator</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/">v1.6</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/designs/multi-hierarchy-elastic-quota-management">v1.7 üöß</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/designs/multi-hierarchy-elastic-quota-management">v1.6</a></li><li><a class="dropdown__link" href="/docs/v1.5/designs/multi-hierarchy-elastic-quota-management">v1.5</a></li><li><a class="dropdown__link" href="/docs/v1.4/designs/multi-hierarchy-elastic-quota-management">v1.4</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/designs/multi-hierarchy-elastic-quota-management" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-Hans/docs/designs/multi-hierarchy-elastic-quota-management" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><a href="https://github.com/koordinator-sh/koordinator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation">Installation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/architecture/overview">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/resource-model">Resource Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/priority">Priority</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/qos">QoS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/user-manuals/gang-scheduling">User Manuals</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/designs/koordlet-overview">Design Details</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/koordlet-overview">Koordlet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/runtime-proxy">RuntimeProxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/nri-mode-resource-management">NRI Mode Resource Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/node-prediction">Node Prediction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/enhanced-scheduler-extension">Enhanced Scheduler Extension</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/load-aware-scheduling">Load-aware Scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/fine-grained-cpu-orchestration">Fine-grained CPU orchestration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/resource-reservation">Resource Reservation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/pod-migration-job">PodMigrationJob</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/descheduler-framework">Descheduler Framework</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/fine-grained-device-scheduling">Fine-grained device scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/gang-scheduling">GangScheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/designs/multi-hierarchy-elastic-quota-management">Multi Hierarchy Elastic Quota Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/koordinator-yarn">Koordinator YARN Copilot</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/node-resource-fit-plus-scoring">Enhanced NodeResourceFit Plugin</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/best-practices/colocation-of-spark-jobs">Best Practices</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Design Details</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Multi Hierarchy Elastic Quota Management</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v1.6</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Multi Hierarchy Elastic Quota Management</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">‚Äã</a></h2><p>When several users or teams share a cluster, fairness of resource allocation is very important. This proposal provides
multi-hierarchy elastic quota management mechanism for the scheduler. </p><ul><li>It supports configuring quota groups in a tree structure, which is similar to the organizational structure of most companies.</li><li>It supports the borrowing / returning of resources between different quota groups, for better resource utilization efficiency.
The busy quota groups can automatically temporarily borrow the resources from the idle quota groups, which can improve the
utilization of the cluster. At the same time, when the idle quota group turn into the busy quota group, it can also automatically
take back the &quot;lent-to&quot; resources.</li><li>It considers the resource fairness between different quota groups. When the busy quota groups borrow the
resources from the idle quota groups, the resources can be allocated to the busy quota groups under some fair rules.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compared-with-competitors">Compared with competitors<a href="#compared-with-competitors" class="hash-link" aria-label="Direct link to Compared with competitors" title="Direct link to Compared with competitors">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="resource-quotas">Resource Quotas<a href="#resource-quotas" class="hash-link" aria-label="Direct link to Resource Quotas" title="Direct link to Resource Quotas">‚Äã</a></h4><p><a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/" target="_blank" rel="noopener noreferrer">Resource Quotas</a> provides the ability to restrain the upper
limit of resource usage in one quota group. The quota group resource usage aggregated based on the pod resource configurations.
Suppose there are still free resources in the cluster, but the resource usage of this quota group is close to the limit.
The quota group cannot flexibly borrow the idle resources from the cluster. The only possible way is to manually adjust the
limit of the quota group, but it is difficult to determine the timing and value of the adjustment when there are lots of
quota groups.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="elastic-quota">Elastic Quota<a href="#elastic-quota" class="hash-link" aria-label="Direct link to Elastic Quota" title="Direct link to Elastic Quota">‚Äã</a></h4><p><a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/kep/9-capacity-scheduling/README.md#goals" target="_blank" rel="noopener noreferrer">Elastic Quota</a>
proposed concepts of &quot;max&quot; and &quot;min&quot;. &quot;Max&quot; is the upper bound of the resource consumption of the consumers. &quot;Min&quot; is the minimum
resources that are guaranteed to ensure the functionality/performance of the consumers. This mechanism allows the workloads
from one quota group to &quot;borrow&quot; unused reserved &quot;min&quot; resources from other quota groups. The unused &quot;min&quot; of one quota group
can be used by other quota groups, under the condition that there is a mechanism to guarantee the &quot;victim&quot; quota group can
consume its &quot;min&quot; resource whenever it needs. </p><p>If multiple quota groups need borrow unused reserved &quot;min&quot; resources from other quota groups at the same time,
the implementation strategy is FIFO, which means that one quota group may occupy all &quot;borrowed-from &quot;resources,
while other quota groups cannot borrow any resources at all from the cluster.</p><p>Neither of the above support multi hierarchy quota management.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">‚Äã</a></h3><ol><li><p>Define API to announce multi hierarchy quota configuration.</p></li><li><p>Provides a scheduler plugin to achieve multi hierarchy quota management ability.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-goalsfuture-work">Non-goals/Future work<a href="#non-goalsfuture-work" class="hash-link" aria-label="Direct link to Non-goals/Future work" title="Direct link to Non-goals/Future work">‚Äã</a></h3><p>Users have two ways to manage GPU quotas. One is to only declare the number of GPU cards in the quota group, but do not
care about the specific card type assigned. The other is to specify the quotas required by different card types. For example,
suppose user A\B both has 10 GPU quota, and cluster has two GPU types A100\V100. quotaA only declare 10 GPU quota, so in the
scheduling process, as long as the total number of GPU cards allocated to A is 10, no matter what the allocation ratio of
a100\v100 is, it will meet the expectation. QuotaB also declare 10 GPU quota, but has more details with V100 is 5 and A100 is 5,
so the maximum allocation of V100 is 5 and A100 is 5 in the scheduling will meet the expectation.</p><p>We know that the GPU card type reflected by the label or annotation on the node, not in the resource dimension, so we can&#x27;t
simply configure nvidia.com/gpu-v100, nvidia.com/gpu-a100 directly into the quota group&#x27;s resource dimension.</p><p>What&#x27;s more complicated is that in a cluster, there will be multiple quota groups like A\B at the same time,
These two modes will conflict. Suppose that the cluster resource has 20 cards, including 10 cards for A100 and 10 cards for V100.
If the scheduler first assigns 10 cards to quota groupA with all V100, then quota group B&#x27;s V100 resource has no way to be guaranteed,
which obviously does not meet expectations. Therefore, we need to solve the problem that if the above two modes coexist,
the quota mechanism can still work normally.</p><p>The above problems will be solved in the next proposal.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proposal">Proposal<a href="#proposal" class="hash-link" aria-label="Direct link to Proposal" title="Direct link to Proposal">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-conceptuser-stories">Key Concept\User Stories<a href="#key-conceptuser-stories" class="hash-link" aria-label="Direct link to Key Concept\User Stories" title="Direct link to Key Concept\User Stories">‚Äã</a></h3><ol><li><p>Each quota group declares its own &quot;min&quot; and &quot;max&quot;. The semantics of &quot;min&quot; is the quota group&#x27;s guaranteed resources,
if quota group&#x27;s &quot;request&quot; less than or equal to &quot;min&quot;, the quota group can obtain equivalent resources to the &quot;request&quot;.
The semantics of &quot;max&quot; is the quota group&#x27;s upper limit of resources. We require &quot;min&quot; to be less than or equal to max.</p></li><li><p>We define &quot;request&quot; as the sum pod&#x27;s request in the quota group. When some quota groups &quot;request&quot; is less than &quot;min&quot;, and some
quota groups &quot;request&quot; is more than &quot;min&quot;, the unused resources of the former can be lent to (or you can choose not to share) the
latter. The latter should use these resources according to the fair rule. When the former needs to use the &quot;lent-to&quot; resources,
the latter should also return the &quot;borrowed-from&quot; resources according to the fair rule.</p></li><li><p>We define the &quot;runtime&quot; as the current actual resource that can be used by the quota group. For a quota group whose &quot;request&quot;
is less than min, the value of &quot;runtime&quot; is equal to &quot;request&quot;. That is to say &quot;request&quot; should be unconditionally satisfied
if the &quot;request&quot; is less than &quot;min&quot;. For a quota group whose &quot;request&quot; is greater than &quot;min&quot;, the value of &quot;runtime&quot; is between
&quot;min&quot; and &quot;max&quot;, and the part exceeding &quot;min&quot; is based on its own &quot;request&quot;, the &quot;lent-to&quot; resources, and the ability of
other quota groups to compete for &quot;lent-to&quot; resources. This will be described in detail below.</p></li><li><p>Hierarchy is very important in a resource-shared cluster. Suppose that the cluster shared by multiple departments, and
each department has multiple teams. If each team is a quota group, we naturally hope that the relationship between departments
and teams is tree shaped. In this way, no matter how to add, delete or adjust quota groups within the department, it is an
internal matter of the department. The cluster administrator only needs to be responsible for the quota configuration at the
level of departments, and the quota group&#x27;s configuration can delegate power to the department itself. Moreover, tree can
help us easily see the summary of resources from the perspective of departments when there are lots of teams in one department.</p></li></ol><p>Another advantage of tree structure is that we can control the scope of the &quot;lent-to&quot; resource. For example, a department only
wants to its quota groups can borrow resources from each other, while the resources of the department do not want to be lent
to other departments. This is very convenient for the tree structure. It should be pointed out that although two levels can
meet most scenarios (the more levels, the higher the maintenance complexity), we will support that the height of the quota-tree
is arbitrary.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-details">Implementation Details<a href="#implementation-details" class="hash-link" aria-label="Direct link to Implementation Details" title="Direct link to Implementation Details">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="calculate-runtimequota">Calculate RuntimeQuota<a href="#calculate-runtimequota" class="hash-link" aria-label="Direct link to Calculate RuntimeQuota" title="Direct link to Calculate RuntimeQuota">‚Äã</a></h4><p>We use an example to introduce how to calculate &quot;runtime&quot;. Suppose the cluster total resource is 100, and has 4 quotas,
the configuration and &quot;request&quot; of each quota group described as below:</p><p><img loading="lazy" alt="image" src="/assets/images/runtimequota1-74410cc31ce756d123d131616062720b.jpg" width="1338" height="732" class="img_ev3q"></p><p>We first calculate the &quot;min&quot; part of &quot;runtime&quot;. It should be like as below:</p><p><img loading="lazy" alt="image" src="/assets/images/runtimequota2-c5a2c35d3999f5897b998213e27275f6.jpg" width="1444" height="736" class="img_ev3q"></p><p>Then we find quota groupA can lent 5 quotas to B\C\D, and the cluster has 40 quotas to allocate, so the sum is 45 for B\C\D
to share. We introduce a new field to represent the allocation fairness, which is called &quot;shared-weight&quot;. &quot;shared-weight&quot; determines
the ability of quota groups to compete for shared resources. That is to say, B/C/D will allocate resources in the cluster according
to its &quot;shared-weight&quot;.</p><p>For example, assuming that the weights of B\C\D are 60\50\80</p><ul><li><p>B can get 45 * 60 / (60 + 50 + 80) = 14</p></li><li><p>C can get 45 * 50 / (60 + 50 + 80) = 12</p></li><li><p>D can get 45 * 80 / (60 + 50 + 80) = 19</p></li></ul><p>However, quota group B only need 5 more due to request is 20 and min is 15, and quota group C and D are still hungry,
so quota group B can share 14 - 5 = 9 to C and D.</p><p><img loading="lazy" alt="image" src="/assets/images/runtimequota3-f6b93a7ae7b63ae9232c3c97d8efd03b.jpg" width="1570" height="782" class="img_ev3q"></p><p>quota group C and D can still share the remained quota of 9 by allocation proportion, which C get 9 <em> 50 / (50 + 80) = 3,
D get 9 </em> 80 / (50 + 80) = 6, and we get the runtime of each quota group finally.</p><p><img loading="lazy" alt="image" src="/assets/images/runtimequota4-1ac93330d7444d8cfc54122eff7597b3.jpg" width="1560" height="778" class="img_ev3q"></p><p>The whole process can be summarized as follows:</p><ol><li><p>The quota divided into two categories, one is whose &quot;request&quot; is less than &quot;min&quot;, we call it &quot;lent-to-quotas&quot;. The other is
whose &quot;request&quot; is greater than &quot;min&quot;, we call it &quot;borrowed-quotas&quot;.</p></li><li><p>Calculate the &quot;runtime&quot; of each quota group not exceed &quot;min&quot;, so we can get how many resources can be lent to &quot;borrowed-quotas&quot;.</p></li><li><p>The &quot;borrowed-quotas&quot; share the resources by allocation proportion. </p></li><li><p>If the new &quot;runtime&quot; is larger than &quot;request&quot;, there will be new resources which can be lent to the rest &quot;borrowed-quotas&quot;.</p></li></ol><p>It is very difficult to manage the weight of thousands of quota groups in a company. Therefore, we need to set a default value
for the &quot;shared-weight&quot;. According to our experience in online operations, using max as the default &quot;shared-weight&quot; of the quota
group can satisfy most scenarios. In this way, &quot;max&quot; has both the meaning of resource ceiling and allocation proportion: the
larger the &quot;max&quot; is, the more resources it wants. For individual special scenarios, the resource administrator can adjust the weight.</p><p>It must be pointed out that if the cluster resources suddenly decrease due to node failure, the sum of &quot;min&quot; may be
greater than the total resources of the cluster. If this case happens, we can&#x27;t grantee &quot;min&quot; of each quota group actually.
So we will reduce the &quot;min&quot; of each quota group in a moderate proportion, which is to ensure that the sum of
&quot;min&quot; actually in effect is less than the total resources of the cluster.</p><p>We need to introduce the concept of &quot;sys-group&quot;. &quot;sys-group&quot; means that the &quot;min&quot; of this quota group is infinite,
and its request will never be bound by the quota. It is usually used for system level pods. When the scheduler starts,
the &quot;sys-group&quot; will be created by default not only in scheduler memory, but also try create the quota group crd.
Its &quot;min&quot; and &quot;max&quot; are INT_MAX. At the same time, its &quot;min&quot; will not be reduced in proportion to the above process.
The real available total resource of normal quota groups is the cluster total resource minus the &quot;used&quot; of the &quot;sys-group&quot;.</p><p>We also need to introduce the concept of &quot;default-group&quot;. If the pod cannot find a matching quota group, it will be
matched to the &quot;default-group&quot;. the &quot;default-group&quot; will be created by default not only in scheduler memory, but also try
create the quota group crd. Its &quot;min&quot; and &quot;max&quot; has default value, users can modify them on demand.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hierarchy">Hierarchy<a href="#hierarchy" class="hash-link" aria-label="Direct link to Hierarchy" title="Direct link to Hierarchy">‚Äã</a></h4><p>We can organize quota groups using quota-tree, each quota group has its own configuration. Currently, we only allow leaf
nodes to submit jobs. An example is as below:</p><p><img loading="lazy" alt="image" src="/assets/images/quotatree1-b68ec769c15547410ee4e5bd6eec1b27.jpg" width="1216" height="792" class="img_ev3q"></p><p>When we calculate the &quot;request&quot; of each quota group. We first count the requests of each parent group from the bottom up,
which is the accumulation of mathematical min(child group request, child group max). </p><p><img loading="lazy" alt="image" src="/assets/images/quotatree2-4dc5d14fca1612f275811ad3e3894b9e.jpg" width="1212" height="792" class="img_ev3q"></p><p>Then we calculate the &quot;runtime&quot; from top to bottom. The &quot;runtime&quot; of the parent quota group is the total resources of the
child quota groups. First we calculate parent quota group&#x27;s &quot;runtime&quot;.</p><p><img loading="lazy" alt="image" src="/assets/images/quotatree3-19edd3d6aec62d109f15d7f190207dcc.jpg" width="1208" height="810" class="img_ev3q"> </p><p>Then we calculate child quota group&#x27;s &quot;runtime&quot;.</p><p><img loading="lazy" alt="image" src="/assets/images/quotatree4-ec7592889798a705a13bda326bf22813.jpg" width="1240" height="820" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="min-guarantee-and-preemption">Min Guarantee and Preemption<a href="#min-guarantee-and-preemption" class="hash-link" aria-label="Direct link to Min Guarantee and Preemption" title="Direct link to Min Guarantee and Preemption">‚Äã</a></h4><p>Considering the following situations, suppose that the cluster has two quotas group A\B. At t0 time, only quota groupA has job
submission, it can borrow from quota group B&#x27;s resource, and the &quot;request&quot; and &quot;used&quot; of quota group are both 100 as below:</p><p><img loading="lazy" alt="image" src="/assets/images/quotaguarantee1-2a56b4053b43e9ad3693262f60af6a9d.jpg" width="1072" height="454" class="img_ev3q"></p><p>At t1 time, quota groupB has job submission too, so the &quot;runtime&quot; of quota group A\B is both 50. However, if quota
groupA don&#x27;t return resource back, quota groupB can&#x27;t assign any resource cause node resource occupied by the quota groupA.</p><p><img loading="lazy" alt="image" src="/assets/images/quotaguarantee2-3d1d87a84c0f6a72153fcb228763391d.jpg" width="1066" height="478" class="img_ev3q"></p><p>The solution is that we will monitor the relationship between &quot;used&quot; and &quot;runtime&quot; of each quota group in the background thread.
If quota group&#x27;s &quot;used&quot; continues to be greater than &quot;runtime&quot;, we will start the forced recycling mechanism to kill
several pods in the order of priority from low to high until the &quot;used&quot; is less than or equal to &quot;runtime&quot;. If some pods
in the quota group do not want to be recycled, we require such pods can only use resource up to &quot;min&quot;. By default, we
assume all pods can use resource beyond &quot;min&quot; if &quot;runtime&quot; larger than &quot;min&quot;.</p><p>We do not adopt the cross quota preemption method to solve the problem that when quota group &quot;used&quot; is less than &quot;runtime&quot;
(to preempt the quota group whose &quot;used&quot; is greater than the &quot;runtime&quot;). Due to each quota group has an accurate runtime,
we can accurately recycle the overused resources of each quota group. This is more direct than preemption.</p><p>In addition, we do not think that cross quota preemption is worth recommending. In principle, the priorities of different
quota groups are not comparable, because they may come from different business lines. The high priority of this business line
is not more important than the low priority of other business lines. Only priorities within a quota group have comparative
significance. So we will not support cross quota preemption temporary. Moreover, in inner quota preemption, we will limit
existUsed - preempted + preempt smaller than runtime.</p><p>It can be seen from the above, if &quot;min&quot; of the quota group is not equal to &quot;max&quot;, the &quot;runtime&quot; part exceeding &quot;min&quot; may
recycled by the scheduler. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-limit">Configuration Limit<a href="#configuration-limit" class="hash-link" aria-label="Direct link to Configuration Limit" title="Direct link to Configuration Limit">‚Äã</a></h4><p>We introduce several constraints to ensure that the quota mechanism works properly.</p><ol><li><p>Except for the first level quota group, we require that the sum of &quot;min&quot; of all sub quota groups should be less than or
equal to the &quot;min&quot; of parent group. The reason for excluding the first level quota group is that the cluster resources
cannot avoid jitter. If the cluster resource reduced, we don&#x27;t want to hinder the update of the quota groups.</p></li><li><p>The &quot;max&quot; of child quota group can be larger than the &quot;max&quot; of parent group. Consider the following scenario, there are
2 subtrees in the cluster, &quot;dev-parent&quot; and &quot;production-parent&quot;. Each subtree has several &quot;quota-groups&quot;. When &quot;production&quot;
is busy, we can limit the resource use of the &quot;dev&quot; by only decreasing the &quot;max&quot; of &quot;dev-parent&quot;, instead of decreasing
the &quot;max&quot; of each sub quota group of &quot;dev-parent&quot;.</p></li><li><p>Parent group cannot run pod. We did receive a request to allow the parent group to submit jobs. The priority of the
parent group&#x27;s self jobs is higher than that of all the sub-groups, which means that the parent group&#x27;s self jobs can
preempt the &quot;runtime&quot; of the sub-group&#x27;s jobs at any time. This is somewhat similar to the hierarchical relationship of
&quot;Town City province&quot;. Due to complexityÔºåwe do not support this issue for now.</p></li><li><p>The parent of node can only be parent group, not child group.</p></li><li><p>A quota group can&#x27;t be converted on the attribute of parent group\child group.</p></li><li><p>We allow a node on the quota tree to freely change its parent node, as long as it does not break the existing detection rules.</p></li></ol><p>We will introduce a new &quot;web-hook&quot; to check the configuration limitation.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extension-point">Extension Point<a href="#extension-point" class="hash-link" aria-label="Direct link to Extension Point" title="Direct link to Extension Point">‚Äã</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="prefilter">PreFilter<a href="#prefilter" class="hash-link" aria-label="Direct link to PreFilter" title="Direct link to PreFilter">‚Äã</a></h5><p>We will check if the (Pod.request + Quota.Used) is less than Quota.Runtime. If not, the scheduling cycle of Pod will fail.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="postfilter">PostFilter<a href="#postfilter" class="hash-link" aria-label="Direct link to PostFilter" title="Direct link to PostFilter">‚Äã</a></h5><p>We will re-implement the method selectVictimsOnNode in defaultPreempt. The original selectVictimsOnNode method selects all
the pods with the lower priority than the preemptor‚Äôs priority as potential victims in a node. For now, we only allow
inner-quota-group preemption.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="cache-and-controller">Cache and Controller<a href="#cache-and-controller" class="hash-link" aria-label="Direct link to Cache and Controller" title="Direct link to Cache and Controller">‚Äã</a></h5><ol><li>We will watch the event of quota group and pod to calculate &quot;runtime&quot; of each quota group. </li><li>We will create a thread to update quota group crd to display &quot;request\used\runtime&quot; periodicity.</li><li>We will create a thread to monitor &quot;used&quot; and &quot;runtime&quot; of each quota group. If quota group&#x27;s &quot;used&quot; continues to be
greater than &quot;runtime&quot;, we will start the forced recycling mechanism to kill several pods in the order of priority from
low to high until the &quot;used&quot; is less than or equal to &quot;runtime&quot;.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api">API<a href="#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="quota">Quota<a href="#quota" class="hash-link" aria-label="Direct link to Quota" title="Direct link to Quota">‚Äã</a></h4><p>We will reuse <a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/kep/9-capacity-scheduling/README.md#goals" target="_blank" rel="noopener noreferrer">Elastic Quota</a>
&#x27;s crd to declare quota group.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ElasticQuota </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TypeMeta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Spec   ElasticQuotaSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status ElasticQuotaStatus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ElasticQuotaSpec </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Min v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResourceList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Max v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResourceList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ElasticQuotaStatus </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Used v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResourceList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>we will also add new annotation and labels to achieve our desired functionality.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/runtime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 8Gi</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/shared-weight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 8Gi</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/is-parent</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/parent-quota-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;parent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/allow-lent-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>quota.scheduling.koordinator.sh/runtime</code> is updated by the scheduler. It reflects the &quot;runtime&quot; of the quota group.</li><li><code>quota.scheduling.koordinator.sh/is-parent</code> is disposed by the user. It reflects the &quot;child\parent&quot; attribute of the quota group. Default is child.</li><li><code>quota.scheduling.koordinator.sh/parent-quota-name</code> is disposed by the user. It reflects the parent quota name. Default is root.</li><li><code>quota.scheduling.koordinator.sh/shared-weight</code> is disposed by the user. It reflects the ability to share the &quot;lent to&quot; resource. Default equals to &quot;max&quot;.</li><li><code>quota.scheduling.koordinator.sh/allow-lent-resource</code> is disposed by the user. It reflects whether quota group allows lent unused &quot;min&quot; to others.</li></ul><p>Here is a example:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> scheduling.sigs.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ElasticQuota</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/runtime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 8Gi</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/shared-weight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 8Gi</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/is-parent</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/parent-quota-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;parent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/allow-lent-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">max</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 40Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nvidia.com/gpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">min</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 20Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nvidia.com/gpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pod">Pod<a href="#pod" class="hash-link" aria-label="Direct link to Pod" title="Direct link to Pod">‚Äã</a></h4><p>We introduce a new label on the pod to associate pod with quota group:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">quota.scheduling.koordinator.sh/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>if pod&#x27;s don&#x27;t have the label, we will follow <a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/kep/9-capacity-scheduling/README.md#goals" target="_blank" rel="noopener noreferrer">Elastic Quota</a>
using namespace to associate pod with quota group.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compatibility">Compatibility<a href="#compatibility" class="hash-link" aria-label="Direct link to Compatibility" title="Direct link to Compatibility">‚Äã</a></h3><p>We are fully compatible with <a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/kep/9-capacity-scheduling/README.md#goals" target="_blank" rel="noopener noreferrer">Elastic Quota</a> &#x27;s interface.
If pod&#x27;s don&#x27;t have the &quot;quota-name&quot; label, we will use the namespace to associate pod with quota group. If the pod has
the &quot;quota-name&quot; label, we will use it to associate pod with quota group instead of namespace. If we can&#x27;t find the
matched quota group, we force the pod to associate with the &quot;default-group&quot;. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unsolved-problems">Unsolved Problems<a href="#unsolved-problems" class="hash-link" aria-label="Direct link to Unsolved Problems" title="Direct link to Unsolved Problems">‚Äã</a></h2><p>Please see Non-goals/Future work.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternatives">Alternatives<a href="#alternatives" class="hash-link" aria-label="Direct link to Alternatives" title="Direct link to Alternatives">‚Äã</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-history">Implementation History<a href="#implementation-history" class="hash-link" aria-label="Direct link to Implementation History" title="Direct link to Implementation History">‚Äã</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">‚Äã</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/koordinator-sh/koordinator.sh/edit/main/docs/designs/multi-hierarchy-elastic-quota-management.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-02-28T01:49:37.000Z">Feb 28, 2025</time></b> by <b>wangjianyu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/designs/gang-scheduling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">GangScheduling</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/designs/koordinator-yarn"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Koordinator YARN Copilot</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a><ul><li><a href="#compared-with-competitors" class="table-of-contents__link toc-highlight">Compared with competitors</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goalsfuture-work" class="table-of-contents__link toc-highlight">Non-goals/Future work</a></li></ul></li><li><a href="#proposal" class="table-of-contents__link toc-highlight">Proposal</a><ul><li><a href="#key-conceptuser-stories" class="table-of-contents__link toc-highlight">Key ConceptUser Stories</a></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation Details</a></li><li><a href="#api" class="table-of-contents__link toc-highlight">API</a></li><li><a href="#compatibility" class="table-of-contents__link toc-highlight">Compatibility</a></li></ul></li><li><a href="#unsolved-problems" class="table-of-contents__link toc-highlight">Unsolved Problems</a></li><li><a href="#alternatives" class="table-of-contents__link toc-highlight">Alternatives</a></li><li><a href="#implementation-history" class="table-of-contents__link toc-highlight">Implementation History</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/designs/docs/installation">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/docs/user-manuals/colocation-profile">User Manuals</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/docs/architecture/overview">Architecture</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/koordinator-sh/shared_invite/zt-1756qoub4-Cn4~esfdlfAPsD7cwO2NzA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack ( #koordinator channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/">DingTalk (GroupID: 33383887)</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/koordinator-sh/koordinator" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <div style="font-size: 18px">
        <br>
        <strong>Koordinator is a <a href="https://www.cncf.io/">Cloud Native Computing Foundation</a> sandbox project</strong>
        <br>
        </div>
        <br>
        <img src="img/cncf-color.svg" alt="CNCF" width="auto" height="100px">
        <br>
        <div style="font-size: 14px">
        The Linux Foundation¬Æ (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a>.
        <br>
        Copyright ¬© 2025 The Koordinator Authors. All rights reserved.
        </div>
        </div></div></div></footer></div>
<script src="/assets/js/runtime~main.d9e3305a.js"></script>
<script src="/assets/js/main.e0aacdd2.js"></script>
</body>
</html>