<!doctype html>
<html class="docs-version-v1.2" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Koordinator RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Koordinator Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Koordinator" href="/opensearch.xml"><title data-rh="true">PodMigrationJob | Koordinator</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://koordinator.sh/docs/designs/pod-migration-job"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_version" content="v1.2"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v1.2"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="v1.2"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v1.2"><meta data-rh="true" property="og:title" content="PodMigrationJob | Koordinator"><meta data-rh="true" name="description" content="Summary"><meta data-rh="true" property="og:description" content="Summary"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://koordinator.sh/docs/designs/pod-migration-job"><link data-rh="true" rel="alternate" href="https://koordinator.sh/docs/designs/pod-migration-job" hreflang="en"><link data-rh="true" rel="alternate" href="https://koordinator.sh/zh-Hans/docs/designs/pod-migration-job" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://koordinator.sh/docs/designs/pod-migration-job" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://FKASWWQYOP-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48d3146e.css">
<link rel="preload" href="/assets/js/runtime~main.4ba32c5a.js" as="script">
<link rel="preload" href="/assets/js/main.a2508d99.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" role="banner"><div class="announcementBarPlaceholder_NC_W"></div><div class="announcementBarContent_KsVm">‚≠êÔ∏è If you like Koordinator, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/koordinator-sh/koordinator">GitHub</a>! ‚≠êÔ∏è</div><button type="button" class="clean-btn close announcementBarClose_FG1z" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Koordinator" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="Koordinator" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Koordinator</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs/">v1.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/designs/pod-migration-job">v1.3 üöß</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/designs/pod-migration-job">v1.2</a></li><li><a class="dropdown__link" href="/docs/v1.1/designs/pod-migration-job">v1.1</a></li><li><a class="dropdown__link" href="/docs/v1.0/designs/pod-migration-job">v1.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/designs/pod-migration-job" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/zh-Hans/docs/designs/pod-migration-job" target="_self" rel="noopener noreferrer" class="dropdown__link">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><a href="https://github.com/koordinator-sh/koordinator" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO menuWithAnnouncementBar_x19h"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation">Installation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/architecture/overview">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/resource-model">Resource Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/priority">Priority</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/qos">QoS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/user-manuals/colocation-profile">User Manuals</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/designs/koordlet-overview">Design Details</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/koordlet-overview">Koordlet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/runtime-proxy">RuntimeProxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/enhanced-scheduler-extension">Enhanced Scheduler Extension</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/load-aware-scheduling">Load-aware Scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/fine-grained-cpu-orchestration">Fine-grained CPU orchestration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/resource-reservation">Resource Reservation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/designs/pod-migration-job">PodMigrationJob</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/descheduler-framework">Descheduler Framework</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/fine-grained-device-scheduling">Fine-grained device scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/gang-scheduling">GangScheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/designs/multi-hierarchy-elastic-quota-management">Multi Hierarchy Elastic Quota Management</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/best-practices/colocation-of-spark-jobs">Best Practices</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/">üè†</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Design Details</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docs/designs/pod-migration-job">PodMigrationJob</a></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v1.2</span><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>PodMigrationJob</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">‚Äã</a></h2><p>This proposal defines a CRD-based Pod migration API, through which the descheduler or other automatic fault recovery components can evict or delete Pods more safely. At the same time, the proposal also describes the specific implementation details of the API.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="motivation">Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">‚Äã</a></h2><p>Migrating Pods is an important capability that many components (such as deschedulers) rely on, and can be used to optimize scheduling or help resolve workload runtime quality issues. We believe that pod migration is a complex process, involving steps such as auditing, resource allocation, and application startup, and is mixed with application upgrading, scaling scenarios, and resource operation and maintenance operations by cluster administrators. Therefore, how to manage the stability risk of this process to ensure that the application does not fail due to the migration of Pods is a very critical issue that must be resolved.</p><p>Therefore, it is necessary to realize a final state-oriented migration capability based on CRD, track the status of each process in the migration, and perceive scenarios such as upgrading and scaling of the application.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="goals">Goals<a class="hash-link" href="#goals" title="Direct link to heading">‚Äã</a></h3><ol><li>Defines a CRD-based Pod Migration Job API, through which the descheduler can evict or delete Pods more safely.</li><li>Describe in detail the design details behind the API.</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="non-goalsfuture-work">Non-Goals/Future Work<a class="hash-link" href="#non-goalsfuture-work" title="Direct link to heading">‚Äã</a></h3><ol><li>A new descheduler framework</li><li>Descheduling capability for different scenarios such as load-aware descheduling, defragemention, etc.</li><li>The details about Deterministic preemption that preempts other Pods for Reservation.</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="proposal">Proposal<a class="hash-link" href="#proposal" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="user-stories">User Stories<a class="hash-link" href="#user-stories" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="story-1">Story 1<a class="hash-link" href="#story-1" title="Direct link to heading">‚Äã</a></h4><p>The descheduler in the K8s community evicts pods to be rescheduled according to different strategies. However, it does not guarantee whether the evicted Pod has resources available after re-creation. If a large number of new Pods are in the Pending state when the resources in the cluster are tight, may lower the application availabilities.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="story-2">Story 2<a class="hash-link" href="#story-2" title="Direct link to heading">‚Äã</a></h4><p>The descheduler evicts the Pod through the Eviction API, and the Eviction API decides whether to delete the Pod according to the PDB status. However, it is unable to perceive workload upgrades, scaling and other scenarios in which Pods are deleted, which will also bring security risks.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="story-3">Story 3<a class="hash-link" href="#story-3" title="Direct link to heading">‚Äã</a></h4><p>The Pod migration capability itself can be provided to users as a service. Users can integrate this API in their own systems to achieve safe migration, and are no longer limited to deschedulers.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="basic-migration-api">Basic Migration API<a class="hash-link" href="#basic-migration-api" title="Direct link to heading">‚Äã</a></h3><p>These APIs provide cluster administrators with more fine-grained migration control capabilities, which can better reduce risks.</p><ul><li><code>scheduling.koordinator.sh/eviction-cost</code> indicates the eviction cost. It can be used to set to an int32. The implicit eviction cost for pods that don&#x27;t set the annotation is 0, negative values are permitted. If set the cost ith <code>math.MaxInt32</code>, it means the Pod will not be evicted. Pods with lower eviction cost are preferred to be evicted before pods with higher eviction cost. If a batch of Pods to be evicted have the same priority, they will be sorted by cost, and the Pod with the smallest cost will be evicted. Although the K8s community has <a href="https://github.com/kubernetes/enhancements/issues/2255" target="_blank" rel="noopener noreferrer">Pod Deletion Cost #2255</a>, it is not a general mechanism. To avoid conflicts with components that use <code>Pod Deletion Cost</code>, users can individually mark the eviction cost for Pods. </li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="pod-migration-job-crd">Pod Migration Job CRD<a class="hash-link" href="#pod-migration-job-crd" title="Direct link to heading">‚Äã</a></h3><p>In order to support the above user stories, a Custom Resource Definition(CRD) named <code>PodMigrationJob</code> is proposed to ensure the migration process safely.  </p><h4 class="anchor anchorWithStickyNavbar_mojV" id="migration-job-spec">Migration Job Spec<a class="hash-link" href="#migration-job-spec" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJob is the Schema for the PodMigrationJob API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// +k8s:openapi-gen=true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// +kubebuilder:resource:scope=Cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJob </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TypeMeta   </span><span class="token string" style="color:#e3116c">`json:&quot;,inline&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta </span><span class="token string" style="color:#e3116c">`json:&quot;metadata,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Spec              PodMigrationJobSpec   </span><span class="token string" style="color:#e3116c">`json:&quot;spec,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status            PodMigrationJobStatus </span><span class="token string" style="color:#e3116c">`json:&quot;status,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobSpec </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Paused indicates whether the PodMigrationJob should to work or not.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Default is false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Paused </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;paused,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TTL controls the PodMigrationJob timeout duration.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TTL </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration </span><span class="token string" style="color:#e3116c">`json:&quot;ttl,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Mode represents the operating mode of the Job</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Default is PodMigrationJobModeReservationFirst</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mode PodMigrationJobMode </span><span class="token string" style="color:#e3116c">`json:&quot;mode,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodRef represents the Pod that be migrated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodRef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference </span><span class="token string" style="color:#e3116c">`json:&quot;podRef&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ReservationOptions defines the Reservation options for migrated Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReservationOptions </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodMigrateReservationOptions </span><span class="token string" style="color:#e3116c">`json:&quot;reservationOptions,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DeleteOptions defines the deleting options for the migrated Pod and preempted Pods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DeleteOptions </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteOptions </span><span class="token string" style="color:#e3116c">`json:&quot;deleteOptions,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobMode </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobModeReservationFirst PodMigrationJobMode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ReservationFirst&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobModeEvictionDirectly PodMigrationJobMode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;EvictDirectly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrateReservationOptions </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ReservationRef if specified, PodMigrationJob will check if the status of Reservation is available.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ReservationRef if not specified, PodMigrationJob controller will create Reservation by Template,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// and update the ReservationRef to reference the Reservation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReservationRef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference </span><span class="token string" style="color:#e3116c">`json:&quot;reservationRef,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Template is the object that describes the Reservation that will be created if not specified ReservationRef</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Template </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ReservationTemplateSpec </span><span class="token string" style="color:#e3116c">`json:&quot;template,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PreemptionOption decides whether to preempt other Pods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// The preemption is safe and reserves resources for preempted Pods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PreemptionOptions </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodMigrationJobPreemptionOptions </span><span class="token string" style="color:#e3116c">`json:&quot;preemptionOptions,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobPreemptionOptions </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Reserved object.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><code>Paused</code> indicates whether the PodMigrationJob should to work or not. In some scenarios, the user does not expect the PodMigrationJob Controller to process the PodMigrationJob immediately, but rather to decide whether to execute it after completing some operations similar to auditing.</li><li><code>TimeoutInSeconds</code> controls the PodMigrationJob timeout duration.</li><li>The <code>PodMigrationJob</code> support two modes defined by the field <code>Mode</code>:<ul><li><code>PodMigrationJobModeReservationFirst</code> means that before migrating a Pod, try to reserve resources through the <code>Reservation</code> API, delete the Pod to be migrated after successfully reserved, and observe the status of the <code>Reservation</code> to ensure that the <code>Reservation</code> is consumed.</li><li><code>PodMigrationJobModeEvictionDirectly</code> indicates that the user clearly knows the risk of evicting the Pod and decides to evict the Pod directly.</li><li>If <code>Mode</code> is not specified, <code>PodMigrationJobModeReservationFirst</code> is used by default</li></ul></li><li><code>PodRef</code> represents the Pod that be migrated.  The field is required.</li><li><code>ReservationOptions</code> defines options for how to reserve resource through <code>Reservation</code> API:<ul><li><code>ReservationRef</code> if is specified, the referenced <code>Reservation</code> instance is used first. In some scenarios, such as defragmentation, in order to ensure the reliability of the upper-layer logic, resources may have been reserved on the target node. In this case, the specified <code>Reservation</code> can be used directly.</li><li><code>Template</code> describes the spec of <code>Reservation</code>. It is often not necessary to set this field. When neither <code>ReservationRef</code> nor <code>Template</code> is specified, the <code>PodMigrationJob controller</code> will construct the <code>ReservationSpec</code> reserved resources according to the Spec of the migrated Pod. If <code>Template</code> is set, the <code>ReservationTemplateSpec</code> and the Spec of the migrated Pod will be merged to construct the <code>ReservationSpec</code> reserved resources.</li><li><code>PreemptionOptions</code> decides whether to preempt other Pods if reserved resources failed. The specific details of preemption will be submitted in a separate proposal description in future work, and will not be expanded here for the time being.</li></ul></li><li><code>DeleteOptions</code> defines the options of delete operation. Whether to delete a Pod through the <code>K8s Delete API</code> or evict a Pod through the <code>K8s Eviction API</code> depends on how the user configures the parameters of the <code>PodMigrationJob Controller</code>. Users only need to set <code>DeleteOptions</code> according to the workload in their own cluster.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="migration-job-status">Migration Job Status<a class="hash-link" href="#migration-job-status" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobStatus </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJobPhase represents the phase of a PodMigrationJob is a simple, high-level summary of where the PodMigrationJob is in its lifecycle.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// e.g. Pending/Running/Failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Phase PodMigrationJobPhase </span><span class="token string" style="color:#e3116c">`json:&quot;phase,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Status represents the current status of PodMigrationJob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// e.g. ReservationCreated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;status,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Reason represents a brief CamelCase message indicating details about why the PodMigrationJob is in this state.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Reason </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;reason,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Message represents a human-readable message indicating details about why the PodMigrationJob is in this state.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;message,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Conditions records the stats of PodMigrationJob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Conditions </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">PodMigrationJobCondition </span><span class="token string" style="color:#e3116c">`json:&quot;conditions,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// NodeName represents the node&#x27;s name of migrated Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NodeName </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;nodeName,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodRef represents the newly created Pod after being migrated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodRef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference </span><span class="token string" style="color:#e3116c">`json:&quot;podRef,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PreemptedPodsRef represents the Pods that be preempted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PreemptedPodsRef </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference </span><span class="token string" style="color:#e3116c">`json:&quot;preemptedPodsRef,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PreemptedPodsReservations records information about Reservations created due to preemption</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PreemptedPodsReservations </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">PodMigrationJobPreemptedReservation </span><span class="token string" style="color:#e3116c">`json:&quot;preemptedPodsReservation,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobPreemptedReservation </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Namespace represents the namespace of Reservation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Namespace </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;namespace,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Name represents the name of Reservation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;name,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// NodeName represents the assigned node for Reservation by scheduler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NodeName </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;nodeName,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Phase represents the Phase of Reservation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Phase </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;phase,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PreemptedPodRef represents the Pod that be preempted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PreemptedPodRef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference </span><span class="token string" style="color:#e3116c">`json:&quot;preemptedPodRef,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodsRef represents the newly created Pods after being preempted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodsRef </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">corev1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference </span><span class="token string" style="color:#e3116c">`json:&quot;podsRef,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobCondition </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Type is the type of the condition.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type PodMigrationJobConditionType </span><span class="token string" style="color:#e3116c">`json:&quot;type&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Status is the status of the condition.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Can be True, False, Unknown.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status PodMigrationJobConditionStatus </span><span class="token string" style="color:#e3116c">`json:&quot;status&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Last time we probed the condition.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +nullable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LastProbeTime metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time </span><span class="token string" style="color:#e3116c">`json:&quot;lastProbeTime,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Last time the condition transitioned from one status to another.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// +nullable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LastTransitionTime metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time </span><span class="token string" style="color:#e3116c">`json:&quot;lastTransitionTime,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Unique, one-word, CamelCase reason for the condition&#x27;s last transition.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Reason </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;reason,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Human-readable message indicating details about last transition.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;message,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobPhase </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJobPending represents the initial status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobPending PodMigrationJobPhase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Pending&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJobRunning represents the PodMigrationJob is being processed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobRunning PodMigrationJobPhase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Running&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJobSucceed represents the PodMigrationJob processed successfully</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobSucceed PodMigrationJobPhase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Succeed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJobFailed represents the PodMigrationJob process failed caused by Timeout, Reservation failed, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobFailed PodMigrationJobPhase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Failed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// PodMigrationJobAborted represents the user forcefully aborted the PodMigrationJob.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobAborted PodMigrationJobPhase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Aborted&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// These are valid conditions of PodMigrationJob.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionReservationCreated             PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ReservationCreated&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionReservationScheduled           PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ReservationScheduled&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionPreemption                     PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Preemption&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionEviction                       PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Eviction&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionPodScheduled                   PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PodScheduled&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionReservationPodBoundReservation PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PodBoundReservation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionReservationBound               PodMigrationJobConditionType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ReservationBound&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// These are valid reasons of PodMigrationJob.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonTimeout                   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Timeout&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonFailedCreateReservation   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FailedCreateReservation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonUnschedulable             </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Unschedulable&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonMissingPod                </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MissingPod&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonMissingReservation        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MissingReservation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonPreempting                </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Preempting&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonPreemptComplete           </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PreemptComplete&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonEvicting                  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Evicting&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonFailedEvict               </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FailedEvict&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonEvictComplete             </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;EvictComplete&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobReasonWaitForPodBindReservation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;WaitForPodBindReservation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodMigrationJobConditionStatus </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionStatusTrue    PodMigrationJobConditionStatus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;True&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionStatusFalse   PodMigrationJobConditionStatus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;False&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PodMigrationJobConditionStatusUnknown PodMigrationJobConditionStatus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Unknown&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="implementation-detailsnotesconstraints">Implementation Details/Notes/Constraints<a class="hash-link" href="#implementation-detailsnotesconstraints" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="podmigrationjob-controller">PodMigrationJob Controller<a class="hash-link" href="#podmigrationjob-controller" title="Direct link to heading">‚Äã</a></h4><p>The difference between <code>PodMigrationJobController</code> and general controller is that <code>PodMigrationJobController</code> will evaluate all pending PodMigrationJobs together (ie PodMigrationJob.Phase is Pending) and select a batch of PodMigrationJob and reconcile them. This selection process is called the arbitration mechanism. The reason why the arbitration mechanism is introduced is mainly to control the stability risk and control the cost of migrating Pods. The arbitration mechanism includes three stages: <code>Group</code>, <code>Filter</code> and <code>Sort</code>.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="group-podmigrationjob">Group PodMigrationJob<a class="hash-link" href="#group-podmigrationjob" title="Direct link to heading">‚Äã</a></h5><p>Aggregate according to different workloads to facilitate the processing of subsequent processes</p><ul><li>Aggregate PodMigrationJob by workload</li><li>Aggregate PodMigrationJob by Node</li><li>Aggregate PodMigrationJob by Namespace</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="filter-podmigrationjob">Filter PodMigrationJob<a class="hash-link" href="#filter-podmigrationjob" title="Direct link to heading">‚Äã</a></h5><ul><li>Check how many PodMigrationJob of each workload are in the Running state, and record them as <strong><em>migratingReplicas</em></strong>. If the <strong><em>migratingReplicas</em></strong> reach a certain threshold, they will be excluded. The detailed algorithm of this threshold is described later.</li><li>Check the number of <strong><em>unavailableReplicas</em></strong> of each workload, and determine whether the <strong><em>unavailableReplicas + migratingReplicas</em></strong> conform to the corresponding <a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/" target="_blank" rel="noopener noreferrer">PDB(Pod Disruption Budget)</a> or <a href="https://openkruise.io/docs/user-manuals/podunavailablebudget" target="_blank" rel="noopener noreferrer">PUB(Pod Unavailable Budget)</a>. If there is no PDB or PUB, use the algorithm to calculate dynamically. If not, exclude the corresponding PodMigrationJob.</li><li>Check the number of Pods being migrated on the node where each target Pod is located. If it exceeds the maximum migration amount for a single node, exclude it.</li><li>Check the number of Pods being migrated in the Namespace where each target Pod is located. If it exceeds the maximum migration amount for a single Namespace, exclude it</li></ul><p>The detailed algorithm of Workload Max Migrating/Unavailable Replicas:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetMaxMigrating</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">replicas </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> intOrPercent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IntOrString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetMaxUnavailable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">replicas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> intOrPercent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetMaxUnavailable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">replicas </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> intOrPercent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IntOrString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> intOrPercent </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> replicas </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;10%&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            intOrPercent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> replicas </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> replicas </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            intOrPercent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            intOrPercent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValueFromIntOrPercent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intOrPercent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> replicas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="sort-podmigrationjob">Sort PodMigrationJob<a class="hash-link" href="#sort-podmigrationjob" title="Direct link to heading">‚Äã</a></h5><ul><li>Pods with higher QoS requirements are given priority, LSE &gt; LSR &gt; LS &gt; BE</li><li>Pods with higher priority will be processed first</li><li>The higher migration priority will be processed first</li><li>If the Pod has already initiated a migration job in the past and it fails, sort by the number of times. The lower the number of times, the priority will be given to processing</li><li>If the workload where the Pod is located has been descheduled for a certain number of times in the past, it is sorted according to the number of times. The lower the number of times, the priority will be processed.</li><li>Sort by the number of replicas being migrated by the workload. The lower the number of replicas being migrated, the priority will be given to processing.</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="execute-podmigrationjob">Execute PodMigrationJob<a class="hash-link" href="#execute-podmigrationjob" title="Direct link to heading">‚Äã</a></h5><ul><li>Update PodMigrationJobStatus.Phase to Running to trigger the PodMigrationJob controller reconcile these jobs</li><li>PodMigrationJob controller reconciles process:<ul><li>If the mode of PodMigrationJob is <code>EvictionDirectly</code>, just delete the Pod through the delete method that configured in PodMigrationJob controller. And update the phase of PodMigrationJob to Success.</li><li>If not specified ReservationOptions.ReservationRef, create the Reservation instance by the reservation template or Pod  spec to reserve resources. And updates the created Reservation instance to the ReservationOptions.ReservationRef.</li><li>Check the status of Reservation to determine whether reserve resource successfully.</li><li>If failed to reserve, abort the PodMigrationJob and update the phase of PodMigrationJob to Fail</li><li>If successfully reserve, delete the Pod through the delete method that configured in PodMigrationJob controller.</li><li>Check the Reservation status to determine whether the Reservation consumed.</li><li>If Reservation consumed, tracks the status of Reservation and update the status to PodMigrationJob</li><li>Update phase of PodMigrationJob to Success.</li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="migration-stability-mechanism">Migration Stability mechanism<a class="hash-link" href="#migration-stability-mechanism" title="Direct link to heading">‚Äã</a></h5><ul><li>Support for disabling this capability by configuration </li><li>Supports a simple central flow control mechanism to limit the number of migrations over a period of time. </li></ul><p>See the Configuration section for more details</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="controller-configuration">Controller Configuration<a class="hash-link" href="#controller-configuration" title="Direct link to heading">‚Äã</a></h4><p>User can configure the <code>MigrationControllerArgs</code> through Koordinator Descheduler ConfigMap. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// MigrationControllerArgs holds arguments used to configure the MigrationController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> MigrationControllerArgs </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TypeMeta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DryRun means only execute the entire migration logic except create Reservation or Delete Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Default is false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DryRun </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;dryRun,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// EvictFailedBarePods allows pods without ownerReferences and in failed phase to be evicted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvictFailedBarePods </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;evictFailedBarePods&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// EvictLocalStoragePods allows pods using local storage to be evicted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvictLocalStoragePods </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;evictLocalStoragePods&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// EvictSystemCriticalPods allows eviction of pods of any priority (including Kubernetes system pods)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvictSystemCriticalPods </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;evictSystemCriticalPods&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// IgnorePVCPods prevents pods with PVCs from being evicted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IgnorePvcPods </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;ignorePvcPods&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// LabelSelector sets whether to apply label filtering when evicting.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Any pod matching the label selector is considered evictable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LabelSelector </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LabelSelector </span><span class="token string" style="color:#e3116c">`json:&quot;labelSelector,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// FlowControlQPS controls the number of arbitrations per second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FlowControlQPS </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;flowControlQPS,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// FlowControlBurst is the maximum number of tokens</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FlowControlBurst </span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;flowControlBurst,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// MaxMigratingPerNode represents he maximum number of pods that can be migrating during migrate per node.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MaxMigratingPerNode </span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;maxMigratingPerNode,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// MaxMigratingPerNamespace represents he maximum number of pods that can be migrating during migrate per namespace.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MaxMigratingPerNamespace </span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;maxMigratingPerNamespace,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// MaxMigratingPerWorkload represents he maximum number of pods that can be migrating during migrate per workload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Value can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MaxMigratingPerWorkload </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IntOrString </span><span class="token string" style="color:#e3116c">`json:&quot;maxMigratingPerWorkload,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// MaxUnavailablePerWorkload represents he maximum number of pods that can be unavailable during migrate per workload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// The unavailable state includes NotRunning/NotReady/Migrating/Evicting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Value can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MaxUnavailablePerWorkload </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">intstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IntOrString </span><span class="token string" style="color:#e3116c">`json:&quot;maxUnavailablePerWorkload,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// EvictionPolicy represents how to delete Pod, support &quot;Delete&quot; and &quot;Eviction&quot;, default value is &quot;Eviction&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvictionPolicy </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;evictionPolicy,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DefaultDeleteOptions defines options when deleting migrated pods and preempted pods through the method specified by EvictionPolicy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultDeleteOptions </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteOptions </span><span class="token string" style="color:#e3116c">`json:&quot;defaultDeleteOptions,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/koordinator-sh/koordinator.sh/edit/main/docs/designs/pod-migration-job.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-04-07T10:02:37.000Z">4/7/2023</time></b> by <b>zwzhang</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/designs/resource-reservation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Resource Reservation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/designs/descheduler-framework"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Descheduler Framework</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a><ul><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goalsfuture-work" class="table-of-contents__link toc-highlight">Non-Goals/Future Work</a></li></ul></li><li><a href="#proposal" class="table-of-contents__link toc-highlight">Proposal</a><ul><li><a href="#user-stories" class="table-of-contents__link toc-highlight">User Stories</a></li><li><a href="#basic-migration-api" class="table-of-contents__link toc-highlight">Basic Migration API</a></li><li><a href="#pod-migration-job-crd" class="table-of-contents__link toc-highlight">Pod Migration Job CRD</a></li><li><a href="#implementation-detailsnotesconstraints" class="table-of-contents__link toc-highlight">Implementation Details/Notes/Constraints</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/designs/docs/installation">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/docs/user-manuals/colocation-profile">User Manuals</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/docs/architecture/overview">Architecture</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/koordinator-sh/shared_invite/zt-1756qoub4-Cn4~esfdlfAPsD7cwO2NzA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack ( #koordinator channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/">DingTalk (GroupID: 33383887)</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/koordinator-sh/koordinator" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/designs/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright ¬© 2023 The Koordinator Authors. All rights reserved.</strong></div></div></div></footer></div>
<script src="/assets/js/runtime~main.4ba32c5a.js"></script>
<script src="/assets/js/main.a2508d99.js"></script>
</body>
</html>